<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Hadiah</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://connect-assets.prosple.com/cdn/ff/nDJLhKo3GxHUnuJJLt-cRdMGUAmxDY2NSAzboL84_ec/1700559379/public/styles/scale_and_crop_center_120x120/public/2023-11/Logo-Pharos-Indonesia-200x200-2023.jpg?itok=4-AmM7sn"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        background: #f1f3f5;
        font-family: "Roboto", sans-serif;
      }
      .navbar-custom {
        background-color: #0d6efd;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .navbar-brand {
        display: flex;
        align-items: center;
        font-size: 1.4rem;
        font-weight: bold;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 0 30px rgba(13, 110, 253, 0.15);
        background-color: #ffffff;
        padding: 1.5rem 1.75rem;
      }
      h2 {
        font-weight: bold;
        margin-bottom: 1rem;
        color: #0d6efd;
      }
      .form-control,
      .form-select {
        border-radius: 0.5rem;
        padding: 0.55rem 0.9rem;
      }
      .btn-primary {
        background-color: #0d6efd;
        border: none;
        padding: 0.65rem;
        font-weight: 500;
        border-radius: 0.5rem;
      }
      .btn-primary:hover {
        background-color: #0b5ed7;
      }
      .form-check-input {
        width: 1.2em;
        height: 1.2em;
        margin-top: 0.1em;
        margin-right: 10px;
        vertical-align: middle;
      }
      .mt-4 {
        margin-top: 1.5rem !important;
      }
      .d-none {
        display: none !important;
      }
      ::placeholder {
        color: #bbb !important;
        opacity: 1;
      }
      .select2-container--bootstrap4 .select2-selection--single {
        white-space: normal;
        height: auto !important;
        min-height: 38px;
      }
      .select2-container--bootstrap4 {
        width: 100% !important;
      }
      .select2-container--bootstrap4
        .select2-selection--single
        .select2-selection__rendered {
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        display: flex !important;
        align-items: center !important;
        height: 100% !important;
        padding-left: 1em;
        /* sesuaikan agar tidak terlalu mepet */
      }
      #loader-wrapper.fade-out {
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }
      .form-check-input {
        border: 2px solid #333 !important;
        width: 1.3em;
        height: 1.3em;
      }
    </style>
  </head>

  <div
    id="loader-wrapper"
    style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    "
  >
    <div
      class="spinner-border text-primary"
      role="status"
      style="width: 4rem; height: 4rem"
    >
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top"
    >
      <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2 me-3" href="#">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            fill="white"
            class="bi bi-bar-chart-line-fill"
            viewBox="0 0 16 16"
          >
            <path
              d="M1 13.5a.5.5 0 0 1 .5-.5H15v1H1.5a.5.5 0 0 1-.5-.5zm6-11A.5.5 0 0 1 7.5 3v8a.5.5 0 0 1-1 0V3A.5.5 0 0 1 7 2.5zm4 3A.5.5 0 0 1 11.5 6v5a.5.5 0 0 1-1 0V6A.5.5 0 0 1 11 5.5zm-8 2A.5.5 0 0 1 3.5 8v3a.5.5 0 0 1-1 0V8A.5.5 0 0 1 3 7.5z"
            />
          </svg>
          <span class="text-white">FORM PROGRAM</span>
        </a>

        <!-- Hamburger di kanan -->
        <button
          class="navbar-toggler ms-auto"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu collapsible di kiri -->
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto mt-2 mt-lg-0 ms-2">
            <li class="nav-item">
              <a
                class="nav-link text-white fw-bold active ms-1"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/"
                >Form Hadiah Trade</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-lg-8 col-md-8">
          <div class="card">
            <h2 class="text-center mb-3 mt-2">
              Form Hadiah Loyalty & Power-Up Q3
            </h2>
            <h5 class="fw-bold text-primary mb-0 pb-0">Input Data</h5>
            <hr
              class="mx-auto mt-3 mb-3"
              style="border-top: 3px dashed #5f5f5f; width: 100%"
            />
            <form id="rewardForm">
              <div class="row g-3 align-items-end">
                <div class="col-md-8">
                  <label for="nip" class="form-label">NIP ASM</label>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Masukkan NIP ASM"
                    id="nip"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <button
                    type="button"
                    class="btn btn-primary w-100"
                    id="searchBtn"
                  >
                    Cek NIP ASM
                  </button>
                </div>

                <div class="col-12">
                  <div class="form-text text-start">
                    <span
                      style="font-style: italic; font-weight: bold; color: #000"
                      >* Untuk ASM Vacant, Masukkan NIP SM. (Khusus VBR Masukkan
                      NIP NSM)</span
                    >
                  </div>
                </div>

                <div class="col-12">
                  <label for="asm" class="form-label">Nama ASM</label>
                  <input type="text" class="form-control" id="asm" disabled />
                </div>

                <div class="col-md-6">
                  <label for="kodePi" class="form-label">Kode Outlet</label>
                  <select class="form-select" id="kodePi" required>
                    <option value="">Pilih Kode Outlet</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="jenisProgram" class="form-label"
                    >Jenis Program</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="jenisProgram"
                    disabled
                  />
                </div>

                <div class="col-md-6">
                  <label for="namaOutlet" class="form-label">Nama Outlet</label>
                  <input
                    type="text"
                    class="form-control"
                    id="namaOutlet"
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label for="jumlahHadiah" class="form-label"
                    >Nominal Hadiah</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="jumlahHadiah"
                    disabled
                  />
                </div>

                <div class="col-12">
                  <label for="jenisHadiah" class="form-label"
                    >Jenis Hadiah</label
                  >
                  <select class="form-select" id="jenisHadiah" required>
                    <option value="">Pilih Jenis</option>
                    <option value="Voucher Alfamart">Voucher Alfamart</option>
                    <option value="Voucher Indomaret">Voucher Indomaret</option>
                    <option value="Voucher MAP">Voucher MAP</option>
                    <option value="E-Wallet">E-Wallet</option>
                    <option value="Barang">Elektronik</option>
                  </select>
                </div>

                <div class="col-12">
                  <div id="voucherFields" class="row g-3 d-none">
                    <div class="col-md-6">
                      <label class="form-label">No. Telepon</label>
                      <input
                        type="text"
                        class="form-control"
                        id="telpVoucher"
                        placeholder="Masukkan No. Telp Penerima"
                        pattern="[0-9]{10,15}"
                        oninvalid="this.setCustomValidity('Nomor telepon harus 10–15 digit angka')"
                        oninput="this.setCustomValidity('')"
                      />
                      <div class="invalid-feedback">
                        Nomor yang Anda masukkan belum sesuai. Silakan periksa
                        kembali.
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Nama Penerima</label>
                      <input
                        type="text"
                        class="form-control"
                        id="namaPenerimaVoucher"
                        placeholder="Masukkan Nama Penerima"
                      />
                    </div>
                    <div class="col-12 mb-3">
                      <label class="form-label">Alamat Pengiriman</label>
                      <textarea
                        class="form-control"
                        id="alamatVoucher"
                        rows="2"
                        placeholder="Contoh: Jl. Limo No.40, RT.8/RW.10, Grogol Sel., Kec. Kby. Lama, Kota Jakarta Selatan, Daerah Khusus Ibukota Jakarta 12220"
                      ></textarea>
                    </div>
                  </div>

                  <div id="ewalletFields" class="row g-3 d-none">
                    <div class="col-md-4">
                      <label class="form-label">Jenis E-Wallet</label>
                      <select class="form-select" id="jenisEwallet">
                        <option value="">Pilih Jenis</option>
                        <option value="DANA">DANA</option>
                        <option value="GOPAY">GOPAY</option>
                        <option value="OVO">OVO</option>
                        <option value="SHOPEEPAY">SHOPEEPAY</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">No. E-Wallet</label>
                      <input
                        type="text"
                        class="form-control"
                        id="noEwallet"
                        pattern="08[0-9]{8,13}"
                        inputmode="numeric"
                        maxlength="15"
                        oninvalid="this.setCustomValidity('Nomor harus diawali 08 dan terdiri dari 10–15 digit angka')"
                        oninput="this.setCustomValidity('')"
                      />
                      <div class="invalid-feedback">
                        Nomor yang Anda masukkan belum sesuai. Silakan periksa
                        kembali.
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Nama Akun E-Wallet</label>
                      <input
                        type="text"
                        class="form-control"
                        id="namaEwallet"
                        placeholder="Contoh: abednegoefra"
                      />
                    </div>
                  </div>

                  <div id="barangFields" class="row g-3 d-none">
                    <div class="col-12">
                      <label class="form-label"
                        >Nama Elektronik (Sesuai Budget Hadiah)</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="namaBarang"
                        placeholder="Contoh: HP Samsung Galaxy A56 8/256 GB"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">No. Telepon</label>
                      <input
                        type="text"
                        class="form-control"
                        id="telpBarang"
                        placeholder="Masukkan No. Telp Penerima"
                        pattern="08[0-9]{8,13}"
                        inputmode="numeric"
                        maxlength="15"
                        oninvalid="this.setCustomValidity('Nomor harus diawali 08 dan terdiri dari 10–15 digit angka')"
                        oninput="this.setCustomValidity('')"
                      />
                      <div class="invalid-feedback">
                        Nomor yang Anda masukkan belum sesuai. Silakan periksa
                        kembali.
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Nama Penerima</label>
                      <input
                        type="text"
                        class="form-control"
                        id="namaPenerimaBarang"
                        placeholder="Masukkan Nama Penerima"
                      />
                    </div>
                    <div class="col-12 mb-3">
                      <label class="form-label">Alamat Pengiriman</label>
                      <textarea
                        class="form-control"
                        id="alamatBarang"
                        rows="2"
                        placeholder="Contoh: Jl. Limo No.40, RT.8/RW.10, Grogol Sel., Kec. Kby. Lama, Kota Jakarta Selatan, Daerah Khusus Ibukota Jakarta 12220"
                      ></textarea>
                    </div>
                  </div>
                </div>

                <div class="col-12 mt-1 mb-2">
                  <div class="p-2 border border-dark border-2 rounded">
                    <div class="form-check d-flex align-items-center">
                      <input
                        class="form-check-input me-2"
                        type="checkbox"
                        id="confirmCheck"
                        required
                      />
                      <label
                        class="form-check-label fw-medium d-flex align-items-center"
                        for="confirmCheck"
                        style="margin: 0"
                      >
                        <strong
                          >SAYA MENYATAKAN DATA YANG DIISI SUDAH BENAR</strong
                        >
                      </label>
                    </div>
                  </div>
                </div>

                <div class="mt-4 mb-2">
                  <button type="submit" class="btn btn-primary w-100">
                    Submit
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbxg3iAMMDjHJLu_3tFcxWAUuKie05IUMs39CKFDf4M10hy34xlJp9AttywmN3NceclX7A/exec";
      window.kodePiMap = {};
      const formatRupiah = (angka) => {
        if (!angka) return "Rp0";
        return "Rp" + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      };

      const validateField = (inputId) => {
        const input = document.getElementById(inputId);
        const isEmpty = input.value.trim() === "";
        input.classList.toggle("is-invalid", isEmpty);
        return !isEmpty;
      };

      document.getElementById("searchBtn").addEventListener("click", () => {
        const nip = document.getElementById("nip").value.trim();
        if (!nip)
          return Swal.fire(
            "Perhatian!",
            "Silakan isi NIP terlebih dahulu.",
            "warning"
          );

        Swal.fire({
          title: "Mencari data...",
          text: "Tunggu sebentar, data sedang diproses :)",
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
            Swal.showLoading();
            document.body.style.overflow = "auto";
          },
        });

        fetch(`${scriptURL}?nip=${nip}`)
          .then((res) => res.json())
          .then((data) => {
            // Reset field program, outlet, hadiah, dan jenis hadiah
            document.getElementById("asm").value = "";
            document.getElementById("kodePi").innerHTML =
              '<option value="">Pilih Kode Outlet</option>';
            document.getElementById("jenisProgram").value = "";
            document.getElementById("namaOutlet").value = "";
            document.getElementById("jumlahHadiah").value = "";
            document.getElementById("jenisHadiah").value = "";
            document.getElementById("voucherFields").classList.add("d-none");
            document.getElementById("ewalletFields").classList.add("d-none");
            document.getElementById("barangFields").classList.add("d-none");

            const jenisHadiahSelect = document.getElementById("jenisHadiah");
            jenisHadiahSelect.innerHTML = `
  <option value="">Pilih Jenis</option>
  <option value="Voucher Alfamart">Voucher Alfamart</option>
  <option value="Voucher Indomaret">Voucher Indomaret</option>
  <option value="Voucher MAP">Voucher MAP</option>
  <option value="E-Wallet">E-Wallet</option>
  <option value="Barang">Elektronik</option>
`;
            $("#jenisHadiah").trigger("change.select2");

            Swal.close();

            if (!data.length)
              return Swal.fire(
                "Data tidak ditemukan",
                "Pastikan NIP valid",
                "error"
              );
            const kodePiSelect = document.getElementById("kodePi");
            kodePiSelect.innerHTML = `<option value="">Pilih Kode PI</option>`;
            data.forEach((item) => {
              // Log debug untuk memastikan isi kodePi dan data terkait
              console.log("Mapping kodePi:", item.kodePi);
              console.log("Detail data:", item);

              // Simpan ke map global untuk pemetaan
              kodePiMap[item.kodePi] = item;

              // Buat opsi dropdown
              const opt = document.createElement("option");
              opt.value = item.kodePi; // hanya simpan kode
              opt.textContent = `${item.kodePi} - ${item.namaOutlet}`; // label tampilan user
              kodePiSelect.appendChild(opt);
            });

            // Isi nama ASM jika ada
            document.getElementById("asm").value = data[0].asm || "";
          });
      });

      document.getElementById("kodePi").addEventListener("change", () => {
        const kode = document.getElementById("kodePi").value;
        const data = window.kodePiMap[kode];
        if (data) {
          document.getElementById("namaOutlet").value = data.namaOutlet || "";
          document.getElementById("jumlahHadiah").value = formatRupiah(
            data.jumlahHadiah || 0
          );
          document.getElementById("jenisProgram").value =
            data.jenisProgram || "";

          if ((data.jenisProgram || "").toUpperCase() === "POWER-UP Q2") {
            console.log("Jenis Program POWER-UP Q2 terdeteksi dari Select2.");
          }

          // --- Filter Jenis Hadiah jika POWER-UP Q2 ---
          const jenisHadiahSelect = document.getElementById("jenisHadiah");
          const opsiBarang = [...jenisHadiahSelect.options].find(
            (opt) => opt.value === "Barang"
          );

          if ((data.jenisProgram || "").toUpperCase() === "POWER-UP Q2") {
            console.log(
              "Jenis Program POWER-UP Q2 terdeteksi. Menyembunyikan opsi 'Barang'."
            );

            // Hapus opsi Barang jika ada
            [...jenisHadiahSelect.options].forEach((opt) => {
              if (opt.value === "Barang") {
                console.log(
                  "Menghapus opsi 'Barang' dari dropdown jenisHadiah."
                );
                opt.remove();
              }
            });

            // Reset jika sebelumnya pilih Barang
            if (jenisHadiahSelect.value === "Barang") {
              console.log("Reset pilihan karena sebelumnya memilih 'Barang'");
              jenisHadiahSelect.value = "";
            }

            document.getElementById("barangFields").classList.add("d-none");
          } else {
            console.log(
              "Jenis Program bukan POWER-UP Q2. Memastikan opsi 'Barang' tersedia."
            );

            const barangSudahAda = [...jenisHadiahSelect.options].some(
              (opt) => opt.value === "Barang"
            );
            if (!barangSudahAda) {
              console.log("Menambahkan kembali opsi 'Barang'.");
              const opt = document.createElement("option");
              opt.value = "Barang";
              opt.textContent = "Barang";
              jenisHadiahSelect.appendChild(opt);
            }
          }

          // Trigger ulang Select2 agar update tampilan
          $("#jenisHadiah").trigger("change.select2");
        }
      });

      document.getElementById("jenisHadiah").addEventListener("change", () => {
        const jenis = document.getElementById("jenisHadiah").value;

        const showVoucher = jenis.includes("Voucher");
        const showEwallet = jenis === "E-Wallet";
        const showBarang = jenis === "Barang";

        // Tampilkan atau sembunyikan field sesuai jenis
        document
          .getElementById("voucherFields")
          .classList.toggle("d-none", !showVoucher);
        document
          .getElementById("ewalletFields")
          .classList.toggle("d-none", !showEwallet);
        document
          .getElementById("barangFields")
          .classList.toggle("d-none", !showBarang);

        // Atur atribut required sesuai yang ditampilkan
        document.getElementById("telpVoucher").required = showVoucher;
        document.getElementById("namaPenerimaVoucher").required = showVoucher;
        document.getElementById("alamatVoucher").required = showVoucher;

        document.getElementById("jenisEwallet").required = showEwallet;
        document.getElementById("noEwallet").required = showEwallet;
        document.getElementById("namaEwallet").required = showEwallet;

        document.getElementById("namaBarang").required = showBarang;
        document.getElementById("telpBarang").required = showBarang;
        document.getElementById("namaPenerimaBarang").required = showBarang;
        document.getElementById("alamatBarang").required = showBarang;
      });

      document
        .getElementById("rewardForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          Swal.fire({
            title: "Mengecek data...",
            text: "Tunggu sebentar, data sedang diproses :)",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          const nip = document.getElementById("nip").value;
          const kodePi = document.getElementById("kodePi").value;
          const jenis = document.getElementById("jenisHadiah").value;

          if (!nip || !kodePi || !jenis) {
            Swal.close();
            return Swal.fire(
              "Peringatan",
              "Harap isi semua field utama sebelum submit.",
              "warning"
            );
          }

          const checkRes = await fetch(
            `${scriptURL}?checkKodePi=${encodeURIComponent(kodePi)}`
          );
          const checkData = await checkRes.json();
          if (checkData.found) {
            return Swal.fire({
              icon: "error",
              title: "Kode PI sudah diisi",
              html: `Kode PI <strong>${kodePi}</strong> telah diisi oleh <strong>${checkData.asm}</strong><br>pada <strong>${checkData.timestamp}</strong>.`,
            });
          }

          let isValid = true;

          if (jenis.includes("Voucher")) {
            if (!validateField("namaPenerimaVoucher")) isValid = false;
            if (!validateField("alamatVoucher")) isValid = false;
          }

          if (jenis === "E-Wallet") {
            if (!validateField("jenisEwallet")) isValid = false;
            if (!validateField("namaEwallet")) isValid = false;
          }

          if (jenis === "Barang") {
            if (!validateField("namaBarang")) isValid = false;
            if (!validateField("namaPenerimaBarang")) isValid = false;
            if (!validateField("alamatBarang")) isValid = false;
          }

          if (!isValid) {
            Swal.close();
            return Swal.fire(
              "Peringatan",
              "Mohon lengkapi semua kolom yang diperlukan dengan benar.",
              "warning"
            );
          }

          const formData = {
            nip,
            asm: document.getElementById("asm").value,
            kodePi,
            namaOutlet: document.getElementById("namaOutlet").value,
            jumlahHadiah: (
              document.getElementById("jumlahHadiah").value || ""
            ).replace(/[^\d]/g, ""),
            jenisProgram: document.getElementById("jenisProgram").value,
            jenisHadiah: jenis,
          };

          if (jenis.includes("Voucher")) {
            formData.telp = "'" + document.getElementById("telpVoucher").value;
            formData.namaPenerima = document.getElementById(
              "namaPenerimaVoucher"
            ).value;
            formData.alamat = document.getElementById("alamatVoucher").value;
          } else if (jenis === "E-Wallet") {
            formData.jenisEwallet =
              document.getElementById("jenisEwallet").value;
            formData.noEwallet =
              "'" + document.getElementById("noEwallet").value;
            formData.namaEwallet = document.getElementById("namaEwallet").value;
          } else if (jenis === "Barang") {
            formData.namaBarang = document.getElementById("namaBarang").value;
            formData.telp = "'" + document.getElementById("telpBarang").value;
            formData.namaPenerima =
              document.getElementById("namaPenerimaBarang").value;
            formData.alamat = document.getElementById("alamatBarang").value;
          }

          Swal.fire({
            title: "Menyimpan data...",
            text: "Tunggu sebentar, data sedang diproses :)",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          const res = await fetch(scriptURL, {
            method: "POST",
            body: JSON.stringify(formData),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
          });

          if (res.ok) {
            Swal.fire("Berhasil!", "Data berhasil disimpan.", "success");

            resetFieldTambahan();

            // Kosongkan hanya field tambahan
            document.getElementById("telpVoucher").value = "";
            document.getElementById("namaPenerimaVoucher").value = "";
            document.getElementById("alamatVoucher").value = "";

            document.getElementById("jenisEwallet").value = "";
            document.getElementById("noEwallet").value = "";
            document.getElementById("namaEwallet").value = "";

            document.getElementById("namaBarang").value = "";
            document.getElementById("telpBarang").value = "";
            document.getElementById("namaPenerimaBarang").value = "";
            document.getElementById("alamatBarang").value = "";

            // Reset jenis hadiah dan tampilannya
            document.getElementById("jenisHadiah").value = "";
            $("#jenisHadiah").trigger("change.select2");

            // Sembunyikan field dinamis
            document.getElementById("voucherFields").classList.add("d-none");
            document.getElementById("ewalletFields").classList.add("d-none");
            document.getElementById("barangFields").classList.add("d-none");

            // Reset checkbox konfirmasi
            document.getElementById("confirmCheck").checked = false;

            // Reset field outlet, program, nominal hadiah
            $("#kodePi").val("").trigger("change.select2");
            document.getElementById("namaOutlet").value = "";
            document.getElementById("jenisProgram").value = "";
            document.getElementById("jumlahHadiah").value = "";
          } else {
            Swal.fire(
              "Gagal",
              "Terjadi kesalahan saat mengirim data.",
              "error"
            );
          }
        });

      function resetFieldTambahan() {
        const ids = [
          "telpVoucher",
          "namaPenerimaVoucher",
          "alamatVoucher",
          "jenisEwallet",
          "noEwallet",
          "namaEwallet",
          "namaBarang",
          "telpBarang",
          "namaPenerimaBarang",
          "alamatBarang",
        ];
        ids.forEach((id) => (document.getElementById(id).value = ""));
        document.getElementById("jenisHadiah").value = "";
        $("#jenisHadiah").trigger("change.select2");

        document.getElementById("voucherFields").classList.add("d-none");
        document.getElementById("ewalletFields").classList.add("d-none");
        document.getElementById("barangFields").classList.add("d-none");
        document.getElementById("confirmCheck").checked = false;
      }

      $("#kodePi").on("change", function () {
        const kode = this.value;
        console.log("Kode Outlet dipilih:", kode);
        const data = window.kodePiMap[kode];
        console.log("Data ditemukan:", data);

        const namaOutletEl = document.getElementById("namaOutlet");
        const jumlahHadiahEl = document.getElementById("jumlahHadiah");
        const jenisProgramEl = document.getElementById("jenisProgram");
        const jenisHadiahSelect = document.getElementById("jenisHadiah");

        if (data) {
          namaOutletEl.value = data.namaOutlet || "";
          jumlahHadiahEl.value = formatRupiah(data.jumlahHadiah || 0);
          jenisProgramEl.value = data.jenisProgram || "";

          const jenisProgram = (data.jenisProgram || "").toUpperCase();

          if (jenisProgram === "POWER-UP Q2") {
            // Hapus opsi 'Barang' jika ada
            [...jenisHadiahSelect.options].forEach((opt) => {
              if (opt.value === "Barang") {
                console.log("Menghapus opsi 'Barang' karena POWER-UP Q2.");
                opt.remove();
              }
            });

            // Sembunyikan field barang jika sebelumnya dipilih
            if (jenisHadiahSelect.value === "Barang") {
              console.log("Reset pilihan karena sebelumnya memilih 'Barang'.");
              jenisHadiahSelect.value = "";
              document.getElementById("barangFields").classList.add("d-none");
            }
          } else {
            // Tambahkan kembali opsi 'Barang' jika belum ada
            const barangSudahAda = [...jenisHadiahSelect.options].some(
              (opt) => opt.value === "Barang"
            );
            if (!barangSudahAda) {
              console.log("Menambahkan kembali opsi 'Barang'.");
              const opt = document.createElement("option");
              opt.value = "Barang";
              opt.textContent = "Barang";
              jenisHadiahSelect.appendChild(opt);
            }
          }

          // Trigger Select2 supaya update
          $("#jenisHadiah").trigger("change.select2");
        } else {
          console.warn("Tidak ada data ditemukan untuk kode:", kode);
        }
      });
    </script>
    <script>
      $(document).ready(function () {
        $("#kodePi").select2({
          theme: "bootstrap4",
          placeholder: "Pilih Kode Outlet",
          allowClear: true,
        });
      });

      window.formatRupiah = function (angka) {
        if (!angka) return "Rp0";
        return "Rp" + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      };
      window.addEventListener("load", () => {
        const loader = document.getElementById("loader-wrapper");
        if (loader) {
          loader.classList.add("fade-out");
          setTimeout(() => loader.remove(), 500); // Hapus loader setelah animasi selesai
        }
      });
    </script>
  </body>
</html>
