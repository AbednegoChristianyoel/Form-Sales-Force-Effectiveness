<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Listing MTI & TKOS</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCwxPY-M6lwt7JLZEeexUrhKVgVZj_enHE",
        authDomain: "data-outlet-pharos.firebaseapp.com",
        projectId: "data-outlet-pharos",
        storageBucket: "data-outlet-pharos.appspot.com",
        messagingSenderId: "651086534605",
        appId: "1:651086534605:web:228339d21beb359a709684",
        measurementId: "G-7FQQZ2K3T0",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://connect-assets.prosple.com/cdn/ff/nDJLhKo3GxHUnuJJLt-cRdMGUAmxDY2NSAzboL84_ec/1700559379/public/styles/scale_and_crop_center_120x120/public/2023-11/Logo-Pharos-Indonesia-200x200-2023.jpg?itok=4-AmM7sn"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
      body {
        background: #ffffff;
        font-family: "Roboto", sans-serif;
      }
      .navbar-custom {
        background-color: #0d6efd;
      }
      .navbar-brand {
        display: flex;
        align-items: center;
        font-size: 1.4rem;
        font-weight: bold;
      }
      /* Hover semua link */
      .navbar-nav .nav-link:hover {
        background-color: #0b5ed7;
        color: #fff !important;
        border-radius: 8px !important; /* ✅ radius 8px */
      }
      /* Aktif (halaman sekarang) */
      .navbar-nav .nav-link.active-page {
        background-color: #fff !important;
        color: #0d6efd !important;
        font-weight: bold;
        border-radius: 8px !important; /* ✅ radius 8px */
      }
      /* Hover di link aktif */
      .navbar-nav .nav-link.active-page:hover {
        background-color: #e9f2ff !important;
        color: #0b5ed7 !important;
        border-radius: 8px !important; /* ✅ radius 8px */
      }
      .card {
        border-radius: 8px;
        box-shadow: 0 0 30px rgba(13, 110, 253, 0.15);
        background-color: #ffffff;
        padding: 1.5rem 1.75rem;
      }
      h2 {
        font-weight: bold;
        margin-bottom: 1rem;
        color: #0d6efd;
      }
      .form-control,
      .form-select {
        border-radius: 8px;
        padding: 0.55rem 0.9rem;
      }
      .btn-primary {
        background-color: #0d6efd;
        border: none;
        padding: 0.65rem;
        font-weight: 500;
        border-radius: 8px;
      }
      .ts-wrapper {
        width: 100%;
      }

      .ts-control {
        padding: 0.375rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.275rem; /* sama dengan .form-control */
        min-height: calc(1.5em + 0.75rem + 2px);
        font-size: 1rem;
        background-color: #fff;
        color: #212529;
        line-height: 1.5;
        box-shadow: none;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      .ts-control::placeholder,
      .ts-control input::placeholder,
      .ts-control.single .item {
        color: #6c757d !important;
        opacity: 1 !important;
      }

      .ts-control input {
        font-size: 1rem;
        color: #212529;
        line-height: 1.5;
      }

      .ts-control:focus,
      .ts-control:hover {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }

      .ts-wrapper.single .ts-control {
        display: flex;
        align-items: center;
      }

      .ts-dropdown {
        font-size: 1rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        z-index: 1000;
      }

      .ts-dropdown .active {
        background-color: #f8f9fa;
      }

      .ts-control .item {
        background: none;
        border: none;
        padding-left: 0;
        color: #212529;
      }

      .ts-control .clear-button {
        color: #6c757d;
        margin-left: auto;
      }
      /* Gaya untuk checkbox agar outline hitam */
      .form-check-input[type="checkbox"] {
        border-color: #000; /* Outline hitam */
      }

      /* Saat dicentang */
      .form-check-input[type="checkbox"]:checked {
        background-color: #0b5ed7; /* Kotak hitam */
        border-color: #000; /* Outline hitam */
      }

      /* Hover agar terlihat interaktif */
      .form-check-input[type="checkbox"]:hover {
        border-color: #0b5ed7;
      }

      /* Fokus agar tetap outline hitam */
      .form-check-input[type="checkbox"]:focus {
        border-color: #000;
        box-shadow: 0 0 0 0.25rem rgba(0, 0, 0, 0.25);
      }
      .form-check {
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .form-check-input {
        width: 1rem;
        height: 1rem;
        margin: 0;
        margin-right: 0.3rem;
        flex-shrink: 0;
        vertical-align: middle;
      }

      .form-check-input[type="radio"] {
        margin-top: 0; /* hilangkan margin default */
        vertical-align: middle; /* sejajarkan dengan teks */
      }

      .form-check-label {
        vertical-align: middle; /* teks ikut sejajar */
      }
      ::placeholder {
        color: #bbb !important;
        opacity: 1;
      }
      .readonly-field {
        background-color: #e9ecef !important; /* abu-abu Bootstrap */
        pointer-events: none; /* mencegah klik / ketik */
      }
      table thead th {
        text-align: center;
        vertical-align: middle;
      }
      /* Header gradien */
      .table-gradient {
        background: linear-gradient(90deg, #0d6efd, #4dabf7);
      }

      /* Rounded corner pada table */
      #produkTable {
        border-radius: 8px;
        overflow: hidden;
      }

      /* Hover effect row */
      #produkTable tbody tr:hover {
        background-color: #f1f7ff;
        cursor: pointer;
        transition: 0.2s ease-in-out;
      }

      /* Striping lebih soft */
      #produkTable tbody tr:nth-child(odd) {
        background-color: #fafafa;
      }

      /* Action button lebih modern */
      .btn-action {
        border-radius: 8px;
        padding: 5px 12px;
        font-size: 0.85rem;
        transition: 0.2s;
      }
      .btn-action:hover {
        transform: scale(1.05);
      }
      .btn-success-dark {
        background-color: #006838 !important; /* hijau tua Bootstrap */
        color: #fff !important; /* teks putih */
        border: none;
        padding: 0.65rem;
        font-weight: 500;
        border-radius: 8px;
      }
      .btn-success-dark:hover {
        background-color: #006838 !important; /* versi lebih gelap saat hover */
        color: #fff !important; /* tetap putih saat hover */
      }
      /* Add validation styles */
      .is-invalid {
        border-color: #dc3545 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }
      .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
      }
      .was-validated .form-control:invalid ~ .invalid-feedback,
      .was-validated .form-control:invalid ~ .invalid-tooltip,
      .form-control.is-invalid ~ .invalid-feedback,
      .form-control.is-invalid ~ .invalid-tooltip {
        display: block;
      }
      .btn-logout {
        background: #fff;
        color: #0d6efd;
        border: 1px solid #0d6efd;
      }

      .btn-logout:hover {
        background: #d6e7ff; /* putih kebiruan */
        color: #0b5ed7;
        border-color: #0b5ed7;
      }
      .navbar-collapse {
        text-align: center; /* teks rata tengah */
      }
    </style>
  </head>

  <!-- Loader -->
  <div
    id="loader-wrapper"
    style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    "
  >
    <div
      class="spinner-border text-primary"
      role="status"
      style="width: 4rem; height: 4rem"
    >
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <body>
    <!-- Navbar -->
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top"
    >
      <div class="container">
        <!-- Brand -->
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
          <i class="bi bi-clipboard-check text-white fs-3"></i>
          <span class="text-white fw-bold" style="font-size: 1.4rem"
            >PRO-LISTING</span
          >
        </a>

        <!-- Hamburger Toggle -->
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu Navbar -->
        <div class="collapse navbar-collapse" id="navbarContent">
          <!-- Menu di kiri -->
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item me-2">
              <a
                class="nav-link text-white active-page fw-bold"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/form-listing-mti"
                >FORM LISTING MTI & TKOS</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link text-white fw-bold"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/monitoring-listing-mti"
                >MONITORING LISTING MTI & TKOS</a
              >
            </li>
          </ul>

          <!-- Logout di kanan -->
          <div class="d-flex">
            <button class="btn btn-logout w-100 fw-bold" onclick="logout()">
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-5 mb-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <h2 class="text-center mb-3 mt-2">FORM LISTING MTI & TKOS</h2>
            <h5 class="fw-bold text-primary mt-1 mb-0 pb-0">DATA DIRI SALES</h5>
            <hr
              class="mx-auto mt-3 mb-3"
              style="border-top: 3px dashed #5f5f5f; width: 100%"
            />
            <form id="mtiForm">
              <!-- Bagian NIP -->
              <div class="row g-3 align-items-end">
                <div class="col-md-6">
                  <label for="nipMTI" class="form-label">NIP</label>
                  <input
                    type="text"
                    id="nipMTI"
                    class="form-control"
                    required
                    disabled
                  />
                </div>
                <div class="col-6">
                  <label class="form-label">Nama</label>
                  <input
                    type="text"
                    id="namaMTI"
                    class="form-control"
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Jabatan</label>
                  <input
                    type="text"
                    id="jabatanMTI"
                    class="form-control"
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Divisi</label>
                  <input
                    type="text"
                    id="divisiMTI"
                    class="form-control"
                    disabled
                  />
                </div>

                <!-- Bagian Outlet -->
                <div class="col-12 mt-4">
                  <h5 class="fw-bold text-primary mt-1 mb-3">
                    DETAIL DATA OUTLET
                  </h5>
                  <hr class="my-2" style="border-top: 3px dashed #5f5f5f" />
                </div>

                <!-- Bagian Listing Berbayar -->
                <div class="col-12 mt-3">
                  <label class="form-label fw-bold"
                    >Apakah Listing Ini Berbayar?</label
                  >
                  <div class="d-flex gap-4 mt-1">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="listingBerbayar"
                        id="berbayarYa"
                        value="ya"
                        checked
                      />
                      <label class="form-check-label" for="berbayarYa"
                        >Berbayar</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="listingBerbayar"
                        id="berbayarTidak"
                        value="tidak"
                      />
                      <label class="form-check-label" for="berbayarTidak"
                        >Tidak Berbayar</label
                      >
                    </div>
                  </div>
                </div>

                <div class="col-12 mt-3">
                  <label class="form-label fw-bold">Sektor Outlet</label>
                  <div class="d-flex gap-4 mt-1">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="sektorOutlet"
                        id="sektorMTI"
                        value="MTI"
                        checked
                      />
                      <label class="form-check-label" for="sektorMTI"
                        >MTI</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="sektorOutlet"
                        id="sektorKosmetik"
                        value="Toko Kosmetik"
                      />
                      <label class="form-check-label" for="sektorKosmetik"
                        >Toko Kosmetik</label
                      >
                    </div>
                  </div>
                </div>

                <div class="col-12 mt-3">
                  <label class="form-label fw-bold"
                    >Apakah Outlet Punya Kode PI? (Sudah Pernah
                    Registrasi)</label
                  >
                  <div class="d-flex gap-4 mt-1">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="piOption"
                        id="piAda"
                        value="ada"
                        checked
                      />
                      <label class="form-check-label" for="piAda"
                        >Ada Kode PI</label
                      >
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="piOption"
                        id="piTidak"
                        value="tidak"
                      />
                      <label class="form-check-label" for="piTidak"
                        >Tidak Ada Kode PI</label
                      >
                    </div>
                  </div>
                </div>

                <div class="col-md-12 mt-3" id="dropdownOutlet">
                  <label for="outletMTI" class="form-label">Kode Outlet</label>
                  <select id="outletMTI">
                    <option value="">Pilih Outlet</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label" id="labelKodePi">Kode PI</label>
                  <input
                    type="text"
                    id="kodePi"
                    class="form-control"
                    readonly
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nama Outlet</label>
                  <input
                    type="text"
                    id="namaOutlet"
                    class="form-control"
                    readonly
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Kota</label>
                  <input
                    type="text"
                    id="kotaOutlet"
                    class="form-control"
                    readonly
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Alamat Outlet</label>
                  <input
                    type="text"
                    id="alamatOutlet"
                    class="form-control"
                    readonly
                  />
                </div>

                <div class="col-md-12 mt-3">
                  <label class="form-label">Jumlah Outlet</label>
                  <input
                    type="number"
                    id="jumlahOutlet"
                    class="form-control"
                    placeholder="Masukkan Jumlah Outlet"
                    min="1"
                    required
                  />
                </div>

                <div class="col-12">
                  <label class="form-label d-block fw-bold"
                    >Apakah Mempunyai NPWP?</label
                  >
                  <div class="d-flex gap-3">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="punyaNPWP"
                        id="npwpYa"
                        value="ya"
                        checked
                      />
                      <label class="form-check-label" for="npwpYa">Ya</label>
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="punyaNPWP"
                        id="npwpTidak"
                        value="tidak"
                      />
                      <label class="form-check-label" for="npwpTidak"
                        >Tidak</label
                      >
                    </div>
                  </div>
                </div>

                <div class="col-md-12 mt-3">
                  <label class="form-label">Nomor NPWP / KTP Terdaftar</label>
                  <input
                    type="text"
                    id="nomorktpNPWP"
                    class="form-control"
                    placeholder="Masukkan Nomor NPWP / KTP"
                    required
                  />
                </div>
                <div class="col-md-6 mt-3">
                  <label class="form-label">Tipe NPWP</label>
                  <select id="tipeNPWP" class="form-select">
                    <option value="">Pilih Tipe NPWP</option>
                    <option value="Badan">Badan</option>
                    <option value="Pribadi">Pribadi</option>
                  </select>
                </div>
                <div class="col-md-6 mt-3">
                  <label class="form-label">Nama NPWP Terdaftar</label>
                  <input
                    type="text"
                    id="namaNPWP"
                    class="form-control"
                    placeholder="Masukkan Nama NPWP"
                  />
                </div>
                <div class="col-md-6 mt-3">
                  <label class="form-label">Distributor Coverage</label>
                  <select id="coverageDistributor" class="form-select" required>
                    <option value="">-- Pilih Distributor --</option>
                    <option value="AMS">AMS</option>
                    <option value="PPG">PPG</option>
                  </select>
                </div>
                <div class="col-md-6 mt-3">
                  <label class="form-label">Sub Dist Coverage</label>
                  <select id="subDistCoverage" class="form-select" required>
                    <option value="">-- Pilih Sub Distributor --</option>
                  </select>
                </div>
                <div class="col-md-6 mt-3">
                  <label class="form-label">PKP / NON PKP</label>
                  <select id="statusPKP" class="form-select" required>
                    <option value="">-- Pilih Status --</option>
                    <option value="Release Faktur Pajak">
                      Release Faktur Pajak
                    </option>
                    <option value="Tidak Release Faktur Pajak">
                      Tidak Release Faktur Pajak
                    </option>
                  </select>
                </div>
                <div class="col-md-6 mt-3">
                  <label class="form-label">Gross Up / Non Gross Up</label>
                  <select id="grossUp" class="form-select" required>
                    <option value="">-- Pilih Opsi --</option>
                    <option value="Gross Up">Gross Up</option>
                    <option value="Non Gross Up">Non Gross Up</option>
                  </select>
                </div>

                <!-- Bagian Tambah Produk -->
                <div class="col-12 mt-4">
                  <h5 class="fw-bold text-primary mt-1 mb-3">
                    PLAN ITEM LISTING
                  </h5>
                  <hr class="my-2" style="border-top: 3px dashed #5f5f5f" />

                  <div class="col-md-12 mt-3">
                    <label class="form-label">DC FEE (Optional)</label>
                    <div class="input-group">
                      <span class="input-group-text">Rp</span>
                      <input
                        type="text"
                        id="dcFee"
                        class="form-control"
                        placeholder="Masukkan Nominal DC Fee (Optional)"
                        oninput="formatRupiahInput(this)"
                      />
                    </div>
                  </div>

                  <div class="col-12 mt-3">
                    <label class="form-label fw-bold"
                      >Pilih PT Listing Produk</label
                    >
                    <div class="mt-1">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="ptListing"
                          id="ptPharos"
                          value="PHAROS INDONESIA"
                          checked
                        />
                        <label class="form-check-label" for="ptPharos"
                          >PHAROS INDONESIA</label
                        >
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="ptListing"
                          id="ptFaratu"
                          value="PT. PERUSAHAAN DAGANG DAN INDUSTRI FARATU"
                        />
                        <label class="form-check-label" for="ptFaratu"
                          >PT. PERUSAHAAN DAGANG DAN INDUSTRI FARATU</label
                        >
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="ptListing"
                          id="ptPrima"
                          value="PRIMA MEDIKA LABORATORIES"
                        />
                        <label class="form-check-label" for="ptPrima"
                          >PRIMA MEDIKA LABORATORIES</label
                        >
                      </div>

                      <!-- Tambahan baru -->
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="ptListing"
                          id="ptPrimaxcel"
                          value="PRIMAXCEL INOVASI"
                        />
                        <label class="form-check-label" for="ptPrimaxcel"
                          >PRIMAXCEL INOVASI</label
                        >
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="ptListing"
                          id="ptSaruaSubur"
                          value="PT. SARUA SUBUR"
                        />
                        <label class="form-check-label" for="ptSaruaSubur"
                          >PT. SARUA SUBUR</label
                        >
                      </div>
                    </div>

                    <!-- Notes -->
                    <div class="text-danger fst-italic fw-semibold fs-6 mt-2">
                      ⚠️ Notes: Pengajuan listing tidak boleh dari beda PT
                      (harus dari 1 PT yang sama).
                    </div>
                  </div>
                </div>

                <!-- Table Produk -->
                <div class="table-responsive">
                  <table
                    class="table table-hover align-middle text-center shadow-sm rounded"
                    id="produkTable"
                  >
                    <thead class="table-gradient text-white">
                      <tr>
                        <th>PROCODE</th>
                        <th>NAMA ITEM</th>
                        <th>COST CENTER COVERAGE</th>
                        <th id="labelListingFee">
                          LISTING FEE / ITEM (DPP, EXC PPN)
                        </th>
                        <th>QTY PO (Estimasi)</th>
                        <th>HNA</th>
                        <th>ESTIMASI NILAI PO (RUPIAH)</th>
                        <th>ACTION</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Baris Produk Dinamis -->
                    </tbody>
                  </table>
                </div>

                <!-- Tombol Tambah Produk -->
                <button
                  type="button"
                  class="btn btn-success-dark w-100 mt-3"
                  data-bs-toggle="modal"
                  data-bs-target="#produkModal"
                >
                  + Tambah Produk
                </button>
                <!-- Modal Tambah Produk -->
                <div class="modal fade" id="produkModal" tabindex="-1">
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <!-- <-- Tambahkan modal-dialog-centered -->
                    <div class="modal-content">
                      <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Tambah Produk</h5>
                        <button
                          type="button"
                          class="btn-close btn-close-white"
                          data-bs-dismiss="modal"
                        ></button>
                      </div>
                      <div class="modal-body">
                        <form id="produkForm">
                          <div class="mb-3">
                            <label class="form-label">Pilih Produk</label>
                            <select id="selectProduk" name="selectProduk">
                              <option value=""></option>
                            </select>
                          </div>

                          <div class="row">
                            <div class="col-md-6 mb-2">
                              <label class="form-label">Procode</label>
                              <input
                                type="text"
                                class="form-control bg-light"
                                id="procode"
                                readonly
                              />
                            </div>
                            <div class="col-md-6 mb-2">
                              <label class="form-label">Nama Item</label>
                              <input
                                type="text"
                                class="form-control bg-light"
                                id="itname"
                                readonly
                              />
                            </div>
                            <div class="col-md-12 mb-2">
                              <label class="form-label"
                                >Cost Center Coverage</label
                              >
                              <input
                                type="text"
                                class="form-control bg-light"
                                id="costCenter"
                                readonly
                              />
                            </div>
                            <div class="col-md-6 mb-2">
                              <label class="form-label"
                                >QTY PO (ESTIMASI)</label
                              >
                              <div class="input-group">
                                <input
                                  type="number"
                                  class="form-control"
                                  id="qtyListing"
                                  min="1"
                                />
                                <span class="input-group-text">UB</span>
                              </div>
                            </div>
                            <div class="col-md-6 mb-2">
                              <label class="form-label">HNA</label>
                              <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input
                                  type="text"
                                  class="form-control bg-light"
                                  id="hna"
                                  readonly
                                />
                              </div>
                            </div>
                            <div class="col-md-12 mb-2">
                              <label class="form-label"
                                >Value PO (Estimasi)</label
                              >
                              <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input
                                  type="text"
                                  class="form-control bg-light"
                                  id="valueEstimate"
                                  readonly
                                />
                              </div>
                            </div>
                            <div class="col-md-12 mb-2">
                              <label class="form-label"
                                >Listing Fee / Item (Exc. PPN)</label
                              >
                              <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input
                                  type="text"
                                  class="form-control"
                                  id="listingFee"
                                  oninput="formatRupiahInput(this)"
                                />
                              </div>
                            </div>
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer d-flex justify-content-between">
                        <button
                          type="button"
                          class="btn btn-primary w-100"
                          id="saveProdukBtn"
                        >
                          Simpan Produk
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Ringkasan Perhitungan PO -->
                <div class="mt-4 p-3 border rounded bg-light">
                  <h6 class="fw-bold">RINGKASAN PERHITUNGAN PO (ESTIMASI)</h6>

                  <div class="d-flex justify-content-between fs-6">
                    <div>TOTAL QTY PO (ESTIMASI):</div>
                    <div><span id="totalQty">0</span> UB</div>
                  </div>

                  <div class="d-flex justify-content-between fs-6">
                    <div>TOTAL VALUE PO (ESTIMASI):</div>
                    <div id="totalFeePO">Rp0</div>
                  </div>
                </div>

                <!-- Ringkasan Perhitungan -->
                <div class="mt-4 p-3 border rounded bg-light">
                  <h6 class="fw-bold">RINGKASAN PERHITUNGAN</h6>

                  <div class="d-flex justify-content-between fs-6">
                    <div id="labelTotalFeeListingItem">
                      TOTAL FEE LISTING ITEM:
                    </div>
                    <div id="totalFee">Rp0</div>
                  </div>

                  <div class="d-flex justify-content-between fs-6">
                    <div>DC FEE</div>
                    <div id="dcFeeValue">Rp0</div>
                  </div>

                  <div class="d-flex justify-content-between fs-6">
                    <div>PPN (11%):</div>
                    <div id="ppnValue">Rp0</div>
                  </div>

                  <div class="d-flex justify-content-between fs-6">
                    <div>TOTAL FEE + PPN:</div>
                    <div id="totalFeePPN">Rp0</div>
                  </div>

                  <div class="d-flex justify-content-between fs-6">
                    <div>PPh</div>
                    <div id="pphValue">Rp0</div>
                  </div>

                  <div
                    class="d-flex justify-content-between fw-bold bg-warning mt-2 p-2 rounded"
                  >
                    <div>TOTAL BAYAR:</div>
                    <div id="totalBayar">Rp0</div>
                  </div>

                  <div class="d-flex justify-content-between fs-6 mt-2 fw-bold">
                    <div>Biaya Listing per Item/Outlet</div>
                    <div id="itemperoutlet">Rp0</div>
                  </div>
                </div>

                <!-- Bagian Metode Pembayaran -->
                <div class="col-12 mt-4">
                  <h5 class="fw-bold text-primary mt-1 mb-3">
                    METODE PEMBAYARAN
                  </h5>
                  <hr class="my-2" style="border-top: 3px dashed #5f5f5f" />
                </div>

                <div class="col-md-12 mt-3">
                  <label class="form-label">Jenis Transaksi</label>
                  <select id="jenisTransaksi" class="form-select" required>
                    <option value="">-- Pilih Jenis Transaksi --</option>
                    <option value="Transfer Langsung">Transfer Langsung</option>
                    <option value="Potong Tagihan Distributor">
                      Potong Tagihan Distributor
                    </option>
                  </select>
                </div>

                <div class="col-md-6 mt-3">
                  <label class="form-label">Nomor Rekening</label>
                  <input
                    type="number"
                    id="nomorRekening"
                    class="form-control"
                    placeholder="Masukkan Nomor Rekening"
                    required
                  />
                </div>

                <div class="col-md-6 mt-3">
                  <label class="form-label">Nama Pemilik Rekening</label>
                  <input
                    type="text"
                    id="namaPemilikRekening"
                    class="form-control"
                    placeholder="Masukkan Nama Pemilik Rekening"
                    required
                  />
                </div>

                <div class="col-md-6 mt-3">
                  <label class="form-label">Nama Bank</label>
                  <input
                    type="text"
                    id="namaBank"
                    class="form-control"
                    placeholder="Masukkan Nama Bank"
                    required
                  />
                </div>

                <div class="col-md-6 mt-3">
                  <label class="form-label">Kantor Cabang Pembantu (KCP)</label>
                  <input
                    type="text"
                    id="kcpBank"
                    class="form-control"
                    placeholder="Masukkan Kantor Cabang Pembantu (KCP)"
                    required
                  />
                </div>

                <!-- Section Upload Dokumen Pendukung -->
                <div class="col-12 mt-4">
                  <h5 class="fw-bold text-primary mt-1 mb-3">
                    UPLOAD DOKUMEN PENDUKUNG YANG PERLU DIKIRIM KE HO
                  </h5>
                  <hr class="my-2" style="border-top: 3px dashed #5f5f5f" />
                </div>

                <div class="col-md-12 mt-2">
                  <label class="form-label fw-bold"
                    >Form Listing dari Store
                    <small class="text-danger fst-italic">*wajib</small></label
                  >
                  <input
                    type="file"
                    id="formListingStore"
                    class="form-control"
                    accept=".pdf,.jpg,.jpeg,.png"
                    required
                  />
                </div>

                <div class="col-md-12 mt-2">
                  <label class="form-label fw-bold"
                    >Fotokopi / Scan NPWP / KTP Penanggung Jawab
                    <small class="text-danger fst-italic">*wajib</small></label
                  >
                  <input
                    type="file"
                    id="dokumenNPWPKTP"
                    class="form-control"
                    accept=".pdf,.jpg,.jpeg,.png"
                    required
                  />
                </div>

                <div class="col-md-12 mt-2">
                  <label class="form-label fw-bold"
                    >Scan / Fotokopi Buku Tabungan
                    <small class="text-danger fst-italic">*wajib</small></label
                  >
                  <input
                    type="file"
                    id="bukuTabungan"
                    class="form-control"
                    accept=".pdf,.jpg,.jpeg,.png"
                    required
                  />
                </div>

                <!-- Tambahkan di bawah bagian upload file lainnya (misal setelah Surat Kuasa) -->
                <div class="col-md-12 mt-2">
                  <label class="form-label fw-bold">
                    Pipeline 24 Bulan
                    <small class="text-muted">(opsional)</small>
                  </label>
                  <br />
                  <a
                    href="https://docs.google.com/spreadsheets/d/191UiWRASfdN7hQ2qYfcDuRNsLxC45pnHQo1WQ0gBKEw/edit?gid=0#gid=0"
                    target="_blank"
                    class="fw-bold text-primary text-decoration-underline small"
                  >
                    *Link Template Pipeline 24 Bulan
                  </a>
                  <div class="mt-2">
                    <input
                      type="file"
                      id="pipeline24Bulan"
                      class="form-control"
                      accept=".pdf,.jpg,.jpeg,.png"
                    />
                  </div>
                </div>

                <div class="col-md-12 mt-2">
                  <label class="form-label fw-bold"
                    >Surat Kuasa Penunjukkan Nomor Rekening Penerima (jika nama
                    rekening penerima dengan outlet berbeda)
                    <small class="text-muted">(opsional)</small></label
                  >
                  <input
                    type="file"
                    id="suratKuasa"
                    class="form-control"
                    accept=".pdf,.jpg,.jpeg,.png"
                  />
                </div>

                <!-- Section Informasi Tambahan -->
                <div class="col-12 mt-4">
                  <h5 class="fw-bold text-primary mt-1 mb-3">
                    INFORMASI TAMBAHAN
                  </h5>
                  <hr class="my-2" style="border-top: 3px dashed #5f5f5f" />

                  <div class="col-12 mb-3 mt-3">
                    <label class="form-label fw-medium"
                      >Catatan
                      <small class="text-muted">(opsional)</small></label
                    >
                    <textarea
                      id="catatan"
                      class="form-control"
                      placeholder="Tuliskan catatan tambahan di sini..."
                      rows="2"
                    ></textarea>
                  </div>
                </div>

                <!-- Konfirmasi -->
                <div class="col-12 mt-5">
                  <div class="ps-2 pt-1 border border-dark border-2 rounded">
                    <div class="form-check d-flex align-items-center">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="confirmCheck"
                        required
                      />
                      <label
                        class="form-check-label fw-medium"
                        for="confirmCheck"
                      >
                        <strong>SAYA MENYATAKAN DATA SUDAH BENAR</strong>
                      </label>
                    </div>
                  </div>
                </div>

                <div class="col-12 mt-4">
                  <button type="submit" class="btn btn-primary w-100">
                    Submit Data
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="produkData.js"></script>

    <script>
      const jumlahOutletInput = document.getElementById("jumlahOutlet");

      // Blok karakter non-angka & 0 di depan saat ketik
      jumlahOutletInput.addEventListener("keypress", function (e) {
        const key = e.key;
        const currentValue = this.value;

        // Hanya izinkan angka
        if (!/[0-9]/.test(key)) {
          e.preventDefault();
          return;
        }

        // Kalau posisi pertama dan user ketik "0" → blok
        if (currentValue.length === 0 && key === "0") {
          e.preventDefault();
        }
      });

      // Blok paste teks yang tidak valid
      jumlahOutletInput.addEventListener("paste", function (e) {
        const paste = (e.clipboardData || window.clipboardData).getData("text");

        // Hanya izinkan angka murni & tidak diawali 0
        if (!/^[1-9][0-9]*$/.test(paste)) {
          e.preventDefault();
        }
      });

      let userData = null;
      let globalOutletData = {};
      let tomOutletSelect;

      // 🔹 Fungsi ambil data NIP dan isi form + TomSelect
      async function getDataByNIP(nip) {
        if (!nip) return;

        try {
          Swal.fire({
            title: "Mencari data...",
            text: "Tunggu sebentar, data sedang diproses :)",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          const res = await fetch(
            `https://data-outlet-pharos-default-rtdb.firebaseio.com/${nip}.json`
          );
          const data = await res.json();
          Swal.close();

          if (!data || !data.nama) {
            return Swal.fire(
              "Data Tidak Ditemukan",
              `Data NIP: ${nip} tidak ditemukan.`,
              "error"
            );
          }

          // isi data karyawan
          document.getElementById("nipMTI").value = nip;
          document.getElementById("namaMTI").value = data.nama || "";
          document.getElementById("jabatanMTI").value = data.jabatan || "";
          document.getElementById("divisiMTI").value = data.divisi || "";

          // reset dan isi ulang opsi outlet ke TomSelect
          globalOutletData = {};
          tomOutletSelect.clearOptions();
          tomOutletSelect.addOption({ value: "", text: "Pilih Outlet" });

          (data.outlets || []).forEach((outlet) => {
            globalOutletData[outlet.kode] = outlet;
            tomOutletSelect.addOption({
              value: outlet.kode,
              text: outlet.kode,
            });
          });

          tomOutletSelect.refreshOptions(false);
        } catch (err) {
          Swal.close();
          Swal.fire({
            icon: "error",
            title: "Gagal Mengambil Data",
            text: err.message || err,
          });
        }
      }

      // 🔹 Cek login saat load halaman
      const storedUser = localStorage.getItem("userData");
      if (!storedUser) {
        window.location.href = "../login.html";
      } else {
        userData = JSON.parse(storedUser);
        console.log("User sudah login:", userData);

        if (userData.nip) {
          // otomatis panggil fetch data sesuai NIP
          getDataByNIP(userData.nip);
        } else {
          Swal.fire({
            icon: "warning",
            title: "Data Tidak Ditemukan",
            text: "Silakan login ulang.",
          });
        }
      }

      // 🔹 Inisialisasi TomSelect
      document.addEventListener("DOMContentLoaded", () => {
        tomOutletSelect = new TomSelect("#outletMTI", {
          placeholder: "Pilih Outlet",
          plugins: ["clear_button"],
          closeAfterSelect: true,
          maxOptions: 1000,
        });
      });

      // 🔹 Logout
      // Tambahkan tombol logout jika mau
      function logout() {
        Swal.fire({
          title: "Konfirmasi Keluar",
          text: "Apakah Anda yakin ingin keluar?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ya, Keluar",
          cancelButtonText: "Batal",
          reverseButtons: true,
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem("userData");
            window.location.href = "../login.html";
          }
        });
      }

      // 🔹 Loader fade-out
      window.addEventListener("load", () => {
        const loader = document.getElementById("loader-wrapper");
        if (loader) {
          loader.classList.add("fade-out");
          setTimeout(() => loader.remove(), 500);
        }
      });

      const labelKodePi = document.getElementById("labelKodePi");

      function getNumberFromRupiah(value) {
        if (!value) return 0;
        // buang Rp, titik, spasi, koma
        return parseFloat(value.replace(/Rp|\s|\./g, "")) || 0;
      }

      // event ketika pilih outlet
      document.getElementById("outletMTI").addEventListener("change", (e) => {
        const kode = e.target.value;
        if (globalOutletData[kode]) {
          const o = globalOutletData[kode];
          document.getElementById("kodePi").value = o.kodePi || "";
          document.getElementById("namaOutlet").value = o.nama || "";
          document.getElementById("kotaOutlet").value = o.kota || "";
          document.getElementById("alamatOutlet").value = o.alamat || "";
        } else {
          document.getElementById("kodePi").value = "";
          document.getElementById("namaOutlet").value = "";
          document.getElementById("kotaOutlet").value = "";
          document.getElementById("alamatOutlet").value = "";
        }
      });

      // event ketika ganti pilihan radio ada/tidak kode PI
      document.querySelectorAll('input[name="piOption"]').forEach((radio) => {
        radio.addEventListener("change", togglePiMode);
      });

      function formatRupiahInput(input) {
        // Hapus semua karakter selain angka
        let value = input.value.replace(/\D/g, "");

        // Format angka dengan titik ribuan
        let formatted = new Intl.NumberFormat("id-ID").format(value);

        // Masukkan kembali ke input
        input.value = formatted;
      }

      // 🔥 jalankan sekali saat awal load
      togglePiMode();

      function togglePiMode() {
        const readonly = document.getElementById("piAda").checked;
        const dropdown = document.getElementById("dropdownOutlet");

        if (readonly) {
          // kalau ada kode PI → field readonly + dropdown muncul
          dropdown.style.display = "block";
          labelKodePi.textContent = "Kode PI";

          ["kodePi", "namaOutlet", "kotaOutlet", "alamatOutlet"].forEach(
            (id) => {
              const field = document.getElementById(id);
              field.value = ""; // kosongin dulu
              field.setAttribute("readonly", true);
              field.classList.add("readonly-field");
              field.removeAttribute("placeholder"); // 🔥 hapus hint saat readonly
            }
          );
        } else {
          // kalau tidak ada kode PI → field editable + dropdown hilang
          dropdown.style.display = "none";
          labelKodePi.textContent = "Kode Distributor (Optional)";

          // kosongkan juga dropdown
          tomOutletSelect.clear();

          ["kodePi", "namaOutlet", "kotaOutlet", "alamatOutlet"].forEach(
            (id) => {
              const field = document.getElementById(id);
              field.removeAttribute("readonly");
              field.classList.remove("readonly-field");
              field.value = "";

              // 🔥 tambahkan hint sesuai field
              if (id === "kodePi")
                field.placeholder = "Masukkan Kode Distributor";
              if (id === "namaOutlet")
                field.placeholder = "Masukkan Nama Outlet";
              if (id === "kotaOutlet")
                field.placeholder = "Masukkan Kota Outlet";
              if (id === "alamatOutlet")
                field.placeholder = "Masukkan Alamat Outlet";
            }
          );
        }
      }

      const fieldsToToggle = [
        "statusPKP",
        "grossUp",
        "dcFee",
        "jenisTransaksi",
        "nomorRekening",
        "namaPemilikRekening",
        "namaBank",
        "kcpBank",
        "bukuTabungan",
      ];

      // Simpan opsi default dropdown & placeholder asli
      const dropdownDefaults = {};
      const inputPlaceholders = {};

      fieldsToToggle.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;

        if (el.tagName.toLowerCase() === "select") {
          dropdownDefaults[id] = el.innerHTML;
        } else {
          inputPlaceholders[id] = el.placeholder || "";
        }
      });

      // Toggle bintang required untuk file dan input
      function toggleFieldsBerbayar(isBerbayar) {
        fieldsToToggle.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;

          const tag = el.tagName.toLowerCase();
          const type = el.type;

          // Cari span bintang dalam label
          const label = el.closest("div").querySelector("label .requiredStar");

          if (tag === "select") {
            if (isBerbayar) {
              el.disabled = false;
              el.innerHTML = dropdownDefaults[id];
              el.selectedIndex = 0;
            } else {
              el.disabled = true;
              el.innerHTML = '<option value=""></option>';
              el.value = "";
            }
          } else if (type === "file") {
            el.disabled = !isBerbayar;
            if (!isBerbayar) el.value = "";

            if (label) label.style.display = isBerbayar ? "inline" : "none"; // toggle bintang
          } else {
            if (isBerbayar) {
              el.removeAttribute("readonly");
              if (id !== "dcFee") {
                el.setAttribute("required", true);
              }
              el.style.backgroundColor = "";
              el.placeholder = inputPlaceholders[id];
            } else {
              el.setAttribute("readonly", true);
              if (id !== "dcFee") {
                el.removeAttribute("required");
              }
              el.style.backgroundColor = "#e9ecef";
              el.value = "";
              el.placeholder = "";
            }
          }
        });
        if (!isBerbayar) {
          // kalau tidak berbayar → otomatis NPWP Tidak
          document.getElementById("npwpTidak").checked = true;
        } else {
          // kalau berbayar → otomatis NPWP Ya
          document.getElementById("npwpYa").checked = true;
        }

        // 🔹 trigger event change biar script NPWP jalan
        document
          .querySelectorAll('input[name="punyaNPWP"]')
          .forEach((radio) => radio.dispatchEvent(new Event("change")));
        hitungRingkasan();
      }

      // Event listener radio button
      document
        .getElementById("berbayarYa")
        .addEventListener("change", () => toggleFieldsBerbayar(true));
      document
        .getElementById("berbayarTidak")
        .addEventListener("change", () => toggleFieldsBerbayar(false));

      // Set initial state
      toggleFieldsBerbayar(document.getElementById("berbayarYa").checked);

      // Event toggle NPWP
      document.querySelectorAll('input[name="punyaNPWP"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          const isPunyaNPWP = document.getElementById("npwpYa").checked;

          ["tipeNPWP", "namaNPWP"].forEach((id) => {
            const field = document.getElementById(id);
            if (!isPunyaNPWP) {
              field.value = "";
              field.setAttribute(
                "data-placeholder",
                field.placeholder || field.options?.[0]?.text || ""
              );
              if (field.tagName === "SELECT") {
                field.selectedIndex = -1; // kosongkan dropdown
              } else {
                field.placeholder = ""; // kosongkan hint input
              }
              field.classList.add("disabled-empty");
              field.disabled = true;
            } else {
              field.disabled = false;
              if (field.tagName === "SELECT") {
                // restore default option
                if (field.options.length > 0) {
                  field.selectedIndex = 0; // balik ke "Pilih Tipe NPWP"
                }
              } else {
                field.placeholder =
                  field.getAttribute("data-placeholder") || "";
              }
              field.classList.remove("disabled-empty");
            }
          });
        });
      });

      // 🔹 List subdist berlaku untuk semua distributor
      const subDistList = [
        "Tidak Melalui Subdist",
        "BETHANIA FARMA SEJAHTERA, PT - BANGKO",
        "LAKSA NUSANTARA FARMA, PT - BALIKPAPAN",
        "LIMA JAYA FARMATAMA, PT - PADANG",
        "MASAMEDI INTIFARMINDO, PT - KAB. MAGELANG",
        "MASAMEDI INTIFARMINDO, PT - KAB. SIDOARJO",
        "MASAMEDI INTIFARMINDO, PT - KAB. TASIKMALAYA",
        "MASAMEDI INTIFARMINDO, PT - KOTA BANDUNG",
        "MASAMEDI INTIFARMINDO, PT - KOTA BOGOR",
        "MASAMEDI INTIFARMINDO, PT - KOTA SEMARANG",
        "MASAMEDI INTIFARMINDO, PT - KOTA TANGERANG",
        "MASAMEDI INTIFARMINDO, PT (SMD) - KAB. SUMEDANG",
        "PAUH MANDIRI SEJAHTERA, PT - BENGKULU",
        "PESONA GENDIS SEJATI, PT - KOTA DENPASAR",
        "RESTU INDO MEDICA, PT - MEDAN",
        "RIAU ANDALAN FARMA, PT - PEKANBARU",
        "SARWA MANGGALLA RAYA, PT - JAKARTA UTARA",
        "GLORIA PERKASA JAYA, PT - SOLO",
      ];

      // 🚀 Isi dropdown langsung saat page load
      window.addEventListener("DOMContentLoaded", () => {
        const subDistSelect = document.getElementById("subDistCoverage");
        subDistList.forEach((subdist) => {
          const option = new Option(subdist, subdist);
          subDistSelect.add(option);
        });
        subDistSelect.disabled = false;
        subDistSelect.classList.remove("readonly-field");
      });

      // Data produk
      const selectProduk = document.getElementById("selectProduk");
      let currentPT =
        document.querySelector('input[name="ptListing"]:checked')?.value || "";

      // Tom Select instance
      let tomSelectProduk = new TomSelect("#selectProduk", {
        create: false,
        sortField: { field: "text", direction: "asc" },
        placeholder: "Cari produk...",
      });

      // Fungsi isi dropdown produk sesuai PT
      function loadProdukByPT(pt) {
        tomSelectProduk.clearOptions(); // hapus semua option
        produkData
          .filter((p) => p.costCenter === pt)
          .forEach((p) => {
            tomSelectProduk.addOption({
              value: p.procode,
              text: `${p.itname} (${p.procode})`,
            });
          });

        tomSelectProduk.refreshOptions(false);
      }

      // 🔥 Event ganti PT
      document.querySelectorAll('input[name="ptListing"]').forEach((radio) => {
        radio.addEventListener("change", (e) => {
          const newPT = e.target.value;
          if (newPT === currentPT) return;

          Swal.fire({
            title: "Konfirmasi Ganti PT",
            text: "Mengganti PT akan menghapus semua produk yang sudah dipilih. Apakah Anda yakin ingin melanjutkan?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Ya, ganti PT",
            cancelButtonText: "Batal",
          }).then((result) => {
            if (result.isConfirmed) {
              tomSelectProduk.clear(); // 🔹 reset value yang dipilih
              tomSelectProduk.clearOptions(); // 🔹 hapus semua option lama
              // kosongkan tabel produk
              document.querySelector("#produkTable tbody").innerHTML = "";
              // muat ulang produk sesuai PT
              loadProdukByPT(newPT);
              currentPT = newPT;
              hitungRingkasan();
            } else {
              // batalkan pilihan → kembalikan ke PT sebelumnya
              document.querySelector(
                `input[name="ptListing"][value="${currentPT}"]`
              ).checked = true;
            }
          });
        });
      });

      // 🔥 pertama kali load
      if (currentPT) {
        loadProdukByPT(currentPT);
      }

      // Fungsi format Rupiah
      function formatRupiah(angka) {
        return new Intl.NumberFormat("id-ID").format(angka || 0);
      }

      // Saat pilih produk → isi otomatis
      selectProduk.addEventListener("change", (e) => {
        // Reset semua field dulu
        ["procode", "itname", "costCenter", "listingFee", "hna"].forEach(
          (id) => {
            document.getElementById(id).value = "";
          }
        );

        const selected = produkData.find((p) => p.procode === e.target.value);
        if (selected) {
          document.getElementById("procode").value = selected.procode;
          document.getElementById("itname").value = selected.itname;
          document.getElementById("costCenter").value = selected.costCenter;
          document.getElementById("hna").value = formatRupiah(selected.hna);

          // Set qty default 1
          const qty =
            parseInt(document.getElementById("qtyListing").value) || 0;
          document.getElementById("valueEstimate").value = formatRupiah(
            selected.hna * qty
          );
        }
      });

      // Saat input Qty PO → hitung ulang Value Estimate
      document.getElementById("qtyListing").addEventListener("input", () => {
        const selected = produkData.find(
          (p) => p.procode === selectProduk.value
        );
        if (selected) {
          const qty =
            parseInt(document.getElementById("qtyListing").value) || 0;
          document.getElementById("valueEstimate").value = formatRupiah(
            selected.hna * qty
          );
        }
      });

      document.getElementById("saveProdukBtn").addEventListener("click", () => {
        const requiredFields = [
          "procode",
          "itname",
          "costCenter",
          "listingFee",
          "hna",
          "qtyListing",
          "valueEstimate",
        ];
        const emptyFields = requiredFields.filter(
          (id) => !document.getElementById(id).value
        );

        if (emptyFields.length > 0) {
          Swal.fire({
            icon: "error",
            title: "Data Belum Lengkap",
            html: "Semua field wajib diisi sebelum menyimpan produk.",
          });
          return;
        }

        const qtyListing = parseInt(
          document.getElementById("qtyListing").value
        );
        if (qtyListing < 1) {
          Swal.fire({
            icon: "error",
            title: "Qty tidak valid",
            text: "Jumlah listing minimal 1.",
          });
          return;
        }

        const procode = document.getElementById("procode").value;
        const tbody = document.querySelector("#produkTable tbody");

        const sudahAda = Array.from(tbody.querySelectorAll("tr")).some(
          (row) => row.querySelector("td").textContent === procode
        );
        if (sudahAda) {
          Swal.fire({
            icon: "warning",
            title: "Produk sudah ditambahkan",
            text: "Produk ini sudah ada di tabel dan tidak bisa ditambahkan dua kali.",
          });
          return;
        }

        const optionEl = tomSelectProduk.getOption(procode);
        if (optionEl) {
          optionEl.setAttribute("disabled", "disabled");
          tomSelectProduk.updateOption(procode, {
            value: procode,
            text: optionEl.textContent,
            disabled: true,
          });
        }

        const itname = document.getElementById("itname").value;
        const costCenter = document.getElementById("costCenter").value;
        const listingFeeRaw = document
          .getElementById("listingFee")
          .value.replace(/[^\d]/g, "");
        const hnaRaw = document
          .getElementById("hna")
          .value.replace(/[^\d]/g, "");
        const valueEstimate = document.getElementById("valueEstimate").value;

        let listingFee = parseFloat(listingFeeRaw) || 0;

        const grossUpStatus = document.getElementById("grossUp").value;
        const punyaNPWP = document.getElementById("npwpYa")?.checked;
        const tipeNPWP = document.getElementById("tipeNPWP")?.value;

        if (grossUpStatus === "Gross Up") {
          if (punyaNPWP && tipeNPWP === "Badan") {
            listingFee = listingFee * (100 / 98);
          } else {
            listingFee = listingFee * (100 / 97.5);
          }
        }

        const listingFeeDisplay = Math.round(listingFee);

        // 🔹 Tambahkan konfirmasi jika listingFee 0
        const proceed = () => {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${procode}</td>
      <td>${itname}</td>
      <td>${costCenter}</td>
      <td data-fee="${listingFeeRaw}">Rp${formatRupiah(listingFeeDisplay)}</td>
      <td>${qtyListing}</td>
      <td>Rp${formatRupiah(hnaRaw)}</td>
      <td>${valueEstimate}</td>
      <td>
        <button class="btn btn-danger btn-sm btn-action hapusProdukBtn">
          <i class="bi bi-trash"></i> Hapus
        </button>
      </td>
    `;
          tbody.appendChild(row);

          const option = selectProduk.querySelector(
            `option[value="${procode}"]`
          );
          if (option) option.disabled = true;

          [
            "procode",
            "itname",
            "costCenter",
            "listingFee",
            "hna",
            "valueEstimate",
          ].forEach((id) => (document.getElementById(id).value = ""));
          selectProduk.value = "";
          document.getElementById("qtyListing").value = "";
          document.getElementById("totalQty").value = "";
          tomSelectProduk.clear();

          const modalEl = document.getElementById("produkModal");
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.hide();

          hitungRingkasan();
        };

        if (listingFeeDisplay === 0) {
          Swal.fire({
            icon: "warning",
            title: "Listing Fee Rp0 (Tidak Berbayar)",
            text: "Apakah Anda yakin Listing Feenya Rp0?",
            showCancelButton: true,
            confirmButtonText: "Ya, lanjut",
            cancelButtonText: "Batal",
          }).then((result) => {
            if (result.isConfirmed) {
              proceed();
            }
          });
        } else {
          proceed();
        }
      });

      function enableAllProdukOptions() {
        const options = tomSelectProduk.options;
        for (let key in options) {
          tomSelectProduk.updateOption(key, {
            value: options[key].value,
            text: options[key].text,
            disabled: false, // aktifkan lagi
          });
        }
      }

      document.getElementById("dcFee").addEventListener("input", () => {
        hitungRingkasan();
      });

      // Event hapus produk
      document
        .querySelector("#produkTable tbody")
        .addEventListener("click", (e) => {
          if (e.target.classList.contains("hapusProdukBtn")) {
            const row = e.target.closest("tr");
            const procode = row.querySelector("td").textContent;

            // Aktifkan kembali option produk di dropdown TomSelect
            const optionEl = tomSelectProduk.getOption(procode);
            if (optionEl) {
              optionEl.removeAttribute("disabled");
              tomSelectProduk.updateOption(procode, {
                value: procode,
                text: optionEl.textContent,
                disabled: false,
              });
            }

            row.remove();
            hitungRingkasan();
          }
        });
      function parseCurrency(text) {
        // buang Rp dan spasi
        let cleaned = text.replace(/Rp|\s/g, "");

        // kalau ada format ribuan Eropa (15.384,615)
        // ganti titik ribuan → kosong, koma → titik
        cleaned = cleaned.replace(/\./g, "").replace(/,/g, ".");

        return parseFloat(cleaned) || 0;
      }
      function hitungRingkasan() {
        const tbody = document.querySelector("#produkTable tbody");
        let totalValueEstimate = 0; // total PO
        let totalListingFee = 0; // total fee listing
        let totalQty = 0; //  total qty
        let jmlhItem = 0;

        tbody.querySelectorAll("tr").forEach((row) => {
          const valueEstimateText = row.children[6].textContent;
          const valueEstimate = parseCurrency(valueEstimateText);
          totalValueEstimate += valueEstimate;

          // Ambil listing fee dari data-fee
          const listingFee =
            parseFloat(row.children[3].getAttribute("data-fee")) || 0;
          totalListingFee += listingFee;

          const qty = parseInt(row.children[4].textContent) || 0;
          totalQty += qty;
          jmlhItem += 1;
        });

        // 🔥 Terapkan gross up kalau dipilih
        const grossUpStatus = document.getElementById("grossUp").value;
        const punyaNPWP = document.getElementById("npwpYa")?.checked;
        const tipeNPWP = document.getElementById("tipeNPWP")?.value;

        if (grossUpStatus === "Gross Up") {
          if (punyaNPWP && tipeNPWP === "Badan") {
            totalListingFee = totalListingFee * (100 / 98);
          } else {
            totalListingFee = totalListingFee * (100 / 97.5);
          }
        }

        // ✅ Ambil DC Fee (Optional)
        const dcFeeRaw = document.getElementById("dcFee").value || "0";
        let dcFee = parseCurrency(dcFeeRaw);

        if (grossUpStatus === "Gross Up") {
          if (punyaNPWP && tipeNPWP === "Badan") {
            dcFee = dcFee * (100 / 98);
          } else {
            dcFee = dcFee * (100 / 97.5);
          }
        }

        // Bulatkan ke rupiah
        dcFeeDisplay = Math.round(dcFee);

        // ambil status NPWP, GrossUp, PKP
        const releaseFP = document.getElementById("statusPKP")?.value;

        let totalFeeAdjusted = totalListingFee + dcFee; // ✅ tambah DC Fee ke total

        // PPN
        let ppn = 0;
        if (releaseFP === "Release Faktur Pajak") {
          ppn = totalFeeAdjusted * 0.11;
        }

        // PPh
        let pph = 0;
        if (punyaNPWP && tipeNPWP === "Badan") {
          pph = totalFeeAdjusted * 0.02;
        } else {
          pph = totalFeeAdjusted * 0.025;
        }

        ppn = Math.round(ppn);
        pph = Math.round(pph);
        const totalBayar = Math.round(totalFeeAdjusted + ppn - pph);
        const totalFeePlusPpn = Math.round(totalFeeAdjusted + ppn);

        totalListingFee = Math.round(totalListingFee);

        jumlahOutlet = document.getElementById("jumlahOutlet")?.value || 1;
        if (jmlhItem === 0) jmlhItem = 1;
        listingfeeperitemperoutlet = totalBayar / jmlhItem / jumlahOutlet;
        listingfeeperitemperoutlet = Math.round(listingfeeperitemperoutlet);

        // ✅ Tampilkan hasil
        document.getElementById("totalFeePO").textContent =
          "Rp" + formatRupiah(totalValueEstimate);
        document.getElementById("totalQty").textContent = totalQty;
        document.getElementById("totalFee").textContent =
          "Rp" + formatRupiah(totalListingFee); // hanya produk
        document.getElementById("dcFeeValue").textContent =
          "Rp" + formatRupiah(dcFeeDisplay); // tampilkan DC Fee
        document.getElementById("ppnValue").textContent =
          "Rp" + formatRupiah(ppn);
        document.getElementById("pphValue").textContent =
          "Rp" + formatRupiah(pph);
        document.getElementById("totalFeePPN").textContent =
          "Rp" + formatRupiah(totalFeePlusPpn);
        document.getElementById("totalBayar").textContent =
          "Rp" + formatRupiah(totalBayar);
        document.getElementById("itemperoutlet").textContent =
          "Rp" + formatRupiah(listingfeeperitemperoutlet);

        const pipelineInput = document.getElementById("pipeline24Bulan");
        const pipelineLabel = pipelineInput
          ? pipelineInput.closest(".col-md-12").querySelector("label")
          : null;
        const opsionalText = pipelineLabel?.querySelector("small");

        if (listingfeeperitemperoutlet > 300000) {
          pipelineInput.setAttribute("required", "required");
          if (opsionalText) {
            opsionalText.innerHTML =
              '<span class="text-danger fst-italic">*wajib karena biaya listing per item/outlet > Rp300.000</span>';
          }
        } else {
          pipelineInput.removeAttribute("required");
          if (opsionalText) {
            opsionalText.innerHTML = "(opsional)";
          }
        }
      }

      document
        .getElementById("jumlahOutlet")
        .addEventListener("change", function () {
          hitungRingkasan(); // panggil fungsi A saat nilai berubah
        });

      // Trigger perubahan NPWP, GrossUp, Release Faktur Pajak
      ["npwpYa", "npwpTidak", "tipeNPWP", "grossUp", "statusPKP"].forEach(
        (id) => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("change", hitungRingkasan);
        }
      );
      // Event ganti Gross Up → ubah label
      document
        .getElementById("grossUp")
        .addEventListener("change", function () {
          const labelListing = document.getElementById("labelListingFee");
          const labelTotalFee = document.getElementById(
            "labelTotalFeeListingItem"
          );

          if (this.value === "Gross Up") {
            labelListing.textContent =
              "Listing Fee / Item (DPP, EXC PPN) [Gross Up]";
            labelTotalFee.textContent = "TOTAL FEE LISTING ITEM (GROSS UP):";
          } else {
            labelListing.textContent = "Listing Fee / Item (DPP, EXC PPN)";
            labelTotalFee.textContent = "TOTAL FEE LISTING ITEM:";
          }
        });

      function updateListingFeeDisplay() {
        const grossUpStatus = document.getElementById("grossUp").value;
        const punyaNPWP = document.getElementById("npwpYa")?.checked;
        const tipeNPWP = document.getElementById("tipeNPWP")?.value;

        document.querySelectorAll("#produkTable tbody tr").forEach((row) => {
          const tdFee = row.children[3]; // kolom listing fee
          const originalFee = parseFloat(tdFee.getAttribute("data-fee")) || 0;
          let displayFee = originalFee;

          if (grossUpStatus === "Gross Up") {
            if (punyaNPWP && tipeNPWP === "Badan") {
              displayFee = originalFee * (100 / 98);
            } else {
              displayFee = originalFee * (100 / 97.5);
            }
          }

          // 🔥 Bulatkan ke rupiah
          displayFee = Math.round(displayFee);

          tdFee.textContent = "Rp" + formatRupiah(displayFee);
        });

        hitungRingkasan();
      }

      ["grossUp", "npwpYa", "npwpTidak", "tipeNPWP"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("change", updateListingFeeDisplay);
      });

      document.addEventListener("DOMContentLoaded", function () {
        const piAda = document.getElementById("piAda");
        const piTidak = document.getElementById("piTidak");
        const outletMTI = document.getElementById("outletMTI");
        const kodePi = document.getElementById("kodePi");
        const namaOutlet = document.getElementById("namaOutlet");
        const kotaOutlet = document.getElementById("kotaOutlet");
        const alamatOutlet = document.getElementById("alamatOutlet");

        const npwpYa = document.getElementById("npwpYa");
        const npwpTidak = document.getElementById("npwpTidak");
        const tipeNPWP = document.getElementById("tipeNPWP");
        const namaNPWP = document.getElementById("namaNPWP");

        function updateRequiredFields() {
          // === Validasi PI ===
          if (piAda.checked) {
            outletMTI.required = true;
            kodePi.required = false;
            namaOutlet.required = false;
            kotaOutlet.required = false;
            alamatOutlet.required = false;
          } else if (piTidak.checked) {
            outletMTI.required = false;
            kodePi.required = false;
            namaOutlet.required = true;
            kotaOutlet.required = true;
            alamatOutlet.required = true;
          }

          // === Validasi NPWP ===
          if (npwpYa.checked) {
            tipeNPWP.required = true;
            namaNPWP.required = true;
          } else if (npwpTidak.checked) {
            tipeNPWP.required = false;
            namaNPWP.required = false;
          }
        }

        // Jalankan saat load pertama
        updateRequiredFields();

        // Pas ganti pilihan, update aturan required
        piAda.addEventListener("change", updateRequiredFields);
        piTidak.addEventListener("change", updateRequiredFields);
        npwpYa.addEventListener("change", updateRequiredFields);
        npwpTidak.addEventListener("change", updateRequiredFields);
      });

      function validateFiles() {
        // Misal ada flag isBerbayar (true/false)
        const isBerbayar =
          document.querySelector('input[name="listingBerbayar"]:checked')
            ?.value === "berbayarYa";

        const fileRules = [
          {
            id: "formListingStore",
            required: true,
            label: "Form Listing Store",
          },
          { id: "dokumenNPWPKTP", required: true, label: "NPWP/KTP" },
          {
            id: "bukuTabungan",
            required: isBerbayar, // wajib hanya kalau berbayar
            label: "Buku Tabungan",
          },
          { id: "suratKuasa", required: false, label: "Surat Kuasa" },
          {
            id: "pipeline24Bulan",
            required: false,
            label: "Pipeline 24 Bulan",
          },
        ];

        const allowedTypes = ["application/pdf", "image/jpeg", "image/png"];
        const maxSize = 5 * 1024 * 1024; // 5MB
        let errors = [];

        fileRules.forEach((rule) => {
          const input = document.getElementById(rule.id);
          const file = input.files[0];

          if (rule.required && !file) {
            errors.push(`${rule.label} wajib diupload.`);
          } else if (file) {
            if (!allowedTypes.includes(file.type)) {
              errors.push(`${rule.label} harus berupa PDF, JPG, atau PNG.`);
            }
            if (file.size > maxSize) {
              errors.push(`${rule.label} maksimal 5MB.`);
            }
          }
        });

        if (errors.length > 0) {
          Swal.fire({
            icon: "error",
            title: "Upload tidak valid",
            html: errors.join("<br>"),
          });
          return false;
        }
        return true;
      }

      async function mergeFilesToBase64(fileInputs) {
        const mergedPdf = await PDFLib.PDFDocument.create();

        for (let inputId of fileInputs) {
          const input = document.getElementById(inputId);
          if (!input || !input.files[0]) continue;

          const file = input.files[0];
          const arrayBuffer = await file.arrayBuffer();

          if (file.type === "application/pdf") {
            // === Jika PDF: copy semua page ===
            const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
            const copiedPages = await mergedPdf.copyPages(
              pdf,
              pdf.getPageIndices()
            );
            copiedPages.forEach((page) => mergedPdf.addPage(page));
          } else if (file.type === "image/jpeg" || file.type === "image/png") {
            // === Jika Gambar: convert jadi 1 halaman PDF ===
            let image;
            if (file.type === "image/jpeg") {
              image = await mergedPdf.embedJpg(arrayBuffer);
            } else {
              image = await mergedPdf.embedPng(arrayBuffer);
            }

            const page = mergedPdf.addPage([image.width, image.height]);
            page.drawImage(image, {
              x: 0,
              y: 0,
              width: image.width,
              height: image.height,
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Format tidak didukung",
              text: `${file.name} bukan PDF/JPG/PNG`,
            });
            return null;
          }
        }

        // === Simpan hasil merge ===
        const mergedBytes = await mergedPdf.save();
        const base64String = btoa(
          mergedBytes.reduce(
            (data, byte) => data + String.fromCharCode(byte),
            ""
          )
        );
        return base64String;
      }

      // 🚀 Event submit form utama
      document.getElementById("mtiForm");
      document
        .getElementById("mtiForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // 🚀 Swal Loading duluan
          Swal.fire({
            title: "Mengirim data...",
            text: "Mohon tunggu sebentar :)",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          // Ambil value NPWP/KTP
          const npwpInput = document
            .getElementById("nomorktpNPWP")
            .value.trim();
          const npwpDigits = npwpInput.replace(/\D/g, ""); // hanya angka

          if (npwpDigits.length < 15) {
            Swal.close(); // pastikan loading ditutup dulu

            // beri jeda sedikit supaya loading benar-benar hilang
            setTimeout(() => {
              Swal.fire({
                icon: "error",
                title: "Nomor NPWP / KTP tidak valid",
                text: "Nomor NPWP / KTP harus minimal 15 digit angka.",
                allowOutsideClick: false,
              });
            }, 200); // 200ms sudah cukup

            return; // hentikan proses submit
          }

          // ambil produkList dari tabel
          const produkList = [];
          document.querySelectorAll("#produkTable tbody tr").forEach((row) => {
            const cells = row.querySelectorAll("td");
            produkList.push({
              procode: cells[0].textContent,
              itname: cells[1].textContent,
              costCenter: cells[2].textContent,
              listingFee: getNumberFromRupiah(cells[3].textContent), // hanya angka
              qty: parseInt(cells[4].textContent) || 0,
              hna: getNumberFromRupiah(cells[5].textContent), // hanya angka
              valueEstimate: getNumberFromRupiah(cells[6].textContent), // hanya angka
            });
          });

          if (produkList.length === 0) {
            Swal.close(); // pastikan loading ditutup dulu

            setTimeout(() => {
              // kasih jeda kecil biar swal benar-benar tertutup
              Swal.fire({
                icon: "error",
                title: "Daftar produk kosong",
                text: "Silakan tambahkan setidaknya satu produk.",
                allowOutsideClick: false,
                didClose: () => {
                  const produkTable = document.querySelector("#produkTable");
                  if (produkTable) {
                    produkTable.scrollIntoView({
                      behavior: "smooth",
                      block: "center",
                    });
                    produkTable.style.transition = "background 0.5s";
                    produkTable.style.backgroundColor = "#ffdddd";
                    setTimeout(
                      () => (produkTable.style.backgroundColor = ""),
                      1000
                    );
                  }
                },
              });
            }, 200); // jeda 200ms supaya swal lama benar-benar hilang
            return;
          }

          nip = document.getElementById("nipMTI").value.trim();
          npwp = document.getElementById("nomorktpNPWP").value.trim();

          try {
            const res = await fetch(
              `https://script.google.com/macros/s/AKfycbz5Y49vGaDwfDpz5OC4N9wGQrZC2NqiCFzMBLMFrYZX8D6cWoR5aGuwOdvDiKIGm-JN/exec?action=produk&nip=${nip}&npwp=${npwpDigits}`
            );
            const result = await res.json();

            if (result.result === "success") {
              console.log("Cek produk berhasil:", result.data);
              // Data produk yang sudah ada dengan nip+npwp tsb
              const existingProduk = result.data.map((p) => p["namaProduk"]);

              // cek bentrok
              const duplikat = produkList
                .map((p) => p.itname)
                .filter((p) => existingProduk.includes(p));
              if (duplikat.length > 0) {
                Swal.close();
                Swal.fire({
                  icon: "error",
                  title: "Produk Sudah Pernah Diajukan Listing",
                  html: `
                    Produk di bawah ini sudah pernah diajukan untuk NPWP <b>(${npwpDigits} | ${nip})</b>:
                    <br>
                    <div style="text-align:center; margin-top:8px;">
                      ${duplikat.map((p) => `- ${p}`).join("<br>")}
                    </div>
                  `,
                });
                return; // stop submit
              }
            }
          } catch (err) {
            Swal.close();
            Swal.fire({
              icon: "error",
              title: "Gagal Cek Produk",
              text: err.message,
            });
            return;
          }

          const mergedFileBase64 = await mergeFilesToBase64([
            "formListingStore",
            "dokumenNPWPKTP",
            "bukuTabungan",
            "suratKuasa",
            "pipeline24Bulan",
          ]);

          if (!mergedFileBase64) {
            Swal.close();
            return;
          }

          let kodeInput = document.getElementById("kodePi").value;
          let isPiMode = document.getElementById("piAda").checked;

          const sektorOutlet = document.querySelector(
            'input[name="sektorOutlet"]:checked'
          ).value;

          // susun data sesuai kolom sheet
          const payload = {
            id: "",
            status: "Draft",
            approval: "",
            namaPt:
              document.querySelector('input[name="ptListing"]:checked')
                ?.value || "",
            sektorOutlet: sektorOutlet,
            nip: document.getElementById("nipMTI").value,
            namaSales: document.getElementById("namaMTI").value,
            jabatan: document.getElementById("jabatanMTI").value,
            divisi: document.getElementById("divisiMTI").value,
            ...(isPiMode
              ? { kodePI: kodeInput }
              : { kodeDistributor: kodeInput }),
            namaOutlet: document.getElementById("namaOutlet").value,
            kota: document.getElementById("kotaOutlet").value,
            alamat: document.getElementById("alamatOutlet").value,
            jumlahOutlet: document.getElementById("jumlahOutlet")?.value || "",
            nomorKtp: document.getElementById("nomorktpNPWP")?.value || "",
            tipeNpwp: document.getElementById("tipeNPWP")?.value || "",
            namaNpwp: document.getElementById("namaNPWP")?.value || "",
            distributor: document.getElementById("coverageDistributor").value,
            subDistributor: document.getElementById("subDistCoverage").value,
            pkp: document.getElementById("statusPKP").value,
            grossUp: document.getElementById("grossUp").value,
            metodePembayaran:
              document.getElementById("jenisTransaksi")?.value || "",
            produkList: JSON.stringify(produkList),
            totalQtyPO: document.getElementById("totalQty").textContent,
            totalValuePO: getNumberFromRupiah(
              document.getElementById("totalFeePO").textContent
            ),
            totalListingFee: getNumberFromRupiah(
              document.getElementById("totalFee").textContent
            ),
            dcFee: getNumberFromRupiah(
              document.getElementById("dcFeeValue").textContent
            ),
            ppn: getNumberFromRupiah(
              document.getElementById("ppnValue").textContent
            ),
            feePlusPpn: getNumberFromRupiah(
              document.getElementById("totalFeePPN").textContent
            ),
            pph: getNumberFromRupiah(
              document.getElementById("pphValue").textContent
            ),
            totalBayar: getNumberFromRupiah(
              document.getElementById("totalBayar").textContent
            ),
            noRekening: document.getElementById("nomorRekening")?.value || "",
            namaPemilikRekening:
              document.getElementById("namaPemilikRekening")?.value || "",
            namaBank: document.getElementById("namaBank")?.value || "",
            kcpBank: document.getElementById("kcpBank")?.value || "",
            mergedFile: mergedFileBase64,
            catatan: document.getElementById("catatan")?.value || "",
            namaNsm: userData.namaNsm || "",
          };

          // 🔎 DEBUG: log payload ke console
          console.log("🚀 Payload dikirim ke Apps Script:", payload);

          try {
            const res = await fetch(
              "https://script.google.com/macros/s/AKfycbz5Y49vGaDwfDpz5OC4N9wGQrZC2NqiCFzMBLMFrYZX8D6cWoR5aGuwOdvDiKIGm-JN/exec",
              {
                method: "POST",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload),
              }
            );

            const result = await res.json();

            Swal.close();

            if (result.result === "success") {
              Swal.fire({
                icon: "success",
                title: "Data Berhasil Disimpan",
                text: "Apakah Anda ingin melakukan pengajuan untuk outlet yang sama?",
                showCancelButton: true,
                confirmButtonText: "Ya",
                cancelButtonText: "Tidak",
              }).then((response) => {
                const tbody = document.querySelector("#produkTable tbody");
                if (response.isConfirmed) {
                  // ✅ Ya → reset hanya produk
                  tbody.innerHTML = "";
                  hitungRingkasan();
                  enableAllProdukOptions();
                } else {
                  // ❌ Tidak → reset seluruh form kecuali data diri sales
                  const nip = document.getElementById("nipMTI").value;
                  const nama = document.getElementById("namaMTI").value;
                  const jabatan = document.getElementById("jabatanMTI").value;
                  const divisi = document.getElementById("divisiMTI").value;

                  // reset form
                  e.target.reset();
                  document.querySelector("#produkTable tbody").innerHTML = "";
                  hitungRingkasan();

                  // isi kembali data diri sales
                  document.getElementById("nipMTI").value = nip;
                  document.getElementById("namaMTI").value = nama;
                  document.getElementById("jabatanMTI").value = jabatan;
                  document.getElementById("divisiMTI").value = divisi;
                  enableAllProdukOptions();
                }
              });
            } else {
              throw new Error(
                result.message || "Terjadi kesalahan saat simpan."
              );
            }
          } catch (err) {
            Swal.close();
            console.error("Error submit:", err);
            Swal.fire({
              icon: "error",
              title: "Gagal Simpan",
              text: err.message,
            });
          }
        });
    </script>
  </body>
</html>
