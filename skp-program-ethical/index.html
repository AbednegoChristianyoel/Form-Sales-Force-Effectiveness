<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Print & Upload SKP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap, jQuery, SweetAlert2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://connect-assets.prosple.com/cdn/ff/nDJLhKo3GxHUnuJJLt-cRdMGUAmxDY2NSAzboL84_ec/1700559379/public/styles/scale_and_crop_center_120x120/public/2023-11/Logo-Pharos-Indonesia-200x200-2023.jpg?itok=4-AmM7sn"
    />

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
      body {
        background: #ffffff;
        font-family: "Roboto", sans-serif;
      }

      .navbar-custom {
        background-color: #0d6efd;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .navbar-brand {
        display: flex;
        align-items: center;
        font-size: 1.4rem;
        font-weight: bold;
      }

      /* Hover Effect Navbar */
      .navbar-nav .nav-link {
        transition: background-color 0.3s, color 0.3s;
        border-radius: 0.3rem;
      }

      .navbar-nav .nav-link:hover {
        background-color: #0b5ed7;
        color: #fff;
      }

      h4 {
        font-weight: bold;
        margin-bottom: 1.5rem;
        color: #0d6efd;
      }

      .form-control,
      .form-select {
        border-radius: 0.5rem;
        padding: 0.5rem 0.9rem;
      }

      button,
      .btn {
        font-weight: bold !important;
      }

      .btn-primary {
        background-color: #0d6efd;
        border: none;
        padding: 0.55rem 1rem;
        border-radius: 0.5rem;
      }

      .btn-primary:hover {
        background-color: #0b5ed7;
      }

      ::placeholder {
        color: #bbb !important;
        opacity: 1;
      }

      .card-detail {
        border-radius: 1rem;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        background-color: #fff;
        margin-top: 1rem;
        display: none;
      }

      hr {
        border-top: 2px solid #dee2e6;
        margin-top: 1rem;
        margin-bottom: 1.5rem;
      }

      #skpList {
        margin-top: 1rem;
      }

      .list-group-item {
        border-radius: 0.5rem !important;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }

      .list-group-item:hover {
        background-color: #e9f2ff;
      }

      .swal2-popup {
        font-size: 0.95rem !important;
      }

      .select2-container--default .select2-selection--single {
        height: 38px !important;
        padding: 0.375rem 0.75rem !important;
        line-height: 1.5 !important;
        display: flex !important;
        align-items: center !important;
        border: 1px solid #ced4da;
        border-radius: 0.5rem;
      }

      .select2-selection__rendered {
        padding-left: 0 !important;
        padding-right: 0 !important;
        line-height: 1.5 !important;
        color: #212529 !important;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
      }
      /* Untuk menahan lebar dropdown agar sama dengan select */
      select.form-select {
        width: 100%;
        max-width: 100%;
      }

      select.form-select option {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      .select2-container--default
        .select2-selection--single
        .select2-selection__arrow {
        height: 100% !important;
        top: 50% !important;
        transform: translateY(-50%);
        right: 10px;
        position: absolute;
        pointer-events: none;
      }
      .card-modern {
        border-radius: 1rem;
        transition: all 0.3s ease;
      }
      .card-modern:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }
      .bg-soft-primary {
        background-color: #f1f5ff !important;
        border-bottom: none;
        border-radius: 1rem 1rem 0 0 !important;
      }
      .btn-generate {
        background-color: var(--bs-primary);
        color: white;
      }
      .btn-generate:hover {
        background-color: #0b5ed7; /* warna hover bootstrap primary */
      }
      .btn-upload {
        background-color: #009045;
        color: white;
      }
      .btn-upload:hover {
        background-color: #007a39;
      }
      .card-footer a {
        font-size: 1rem; /* lebih besar dari default */
        font-weight: 600; /* sedikit lebih tebal */
      }
      /* üîπ Logo LUMORA */
      .lumora-logo {
        font-family: "Orbitron", sans-serif;
        letter-spacing: 1px;
        font-size: 1.6rem;
        display: inline-block;
        color: #ffd54f;
        animation: goldGlow 3s ease-in-out infinite,
          floatY 4s ease-in-out infinite;
        text-shadow: 0 0 4px #fff8e1, 0 0 8px #ffcc80; /* Shadow awal */
      }

      /* üîπ Ikon Petir */
      .lightning-icon {
        animation: yellowFlash 2.2s ease-in-out infinite,
          floatY 4s ease-in-out infinite;
        transform-origin: center;
        filter: drop-shadow(0 0 4px #fff8e1) drop-shadow(0 0 8px #ffcc80); /* Glow sama dengan teks */
      }

      /* Glow kuning-oranye elegan */
      @keyframes goldGlow {
        0%,
        100% {
          text-shadow: 0 0 4px #fff8e1, 0 0 8px #ffcc80;
          color: #ffd54f;
        }
        50% {
          text-shadow: 0 0 6px #fff4c2, 0 0 12px #ffb74d;
          color: #ffb300;
        }
      }

      /* Floating sinkron */
      @keyframes floatY {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-2px);
        }
      }

      /* Flash Petir lembut dengan shadow */
      @keyframes yellowFlash {
        0%,
        100% {
          fill: #ffffff;
          filter: drop-shadow(0 0 3px #fff9c4) drop-shadow(0 0 6px #ffecb3);
        }
        50% {
          fill: #ffeb3b;
          filter: drop-shadow(0 0 5px #fff4c2) drop-shadow(0 0 10px #ffd54f);
        }
      }
      #loader-wrapper.fade-out {
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }
    </style>
  </head>

  <div
    id="loader-wrapper"
    style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    "
  >
    <div
      class="spinner-border text-primary"
      role="status"
      style="width: 4rem; height: 4rem"
    >
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <body>
    <!-- Navbar -->
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top"
    >
      <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2 me-3" href="#">
          <!-- üîπ ICON PETIR -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            class="bi bi-lightning-charge-fill lightning-icon"
            viewBox="0 0 16 16"
          >
            <path d="M11 0L6 9h4l-1 7 5-10H9l2-6z" />
          </svg>

          <!-- üîπ NAMA BRAND -->
          <span class="text-white lumora-logo animated-logo">Pro-Ethic</span>
        </a>

        <!-- Hamburger di kanan -->
        <button
          class="navbar-toggler ms-auto"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu collapsible di kiri -->
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto mt-2 mt-lg-0 ms-2">
            <li class="nav-item">
              <a
                class="nav-link text-white fw-bold ms-1"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/form-pendaftaran-program-ethical"
                >Form Ethical</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link text-white fw-bold ms-1"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/skp-program-ethical/"
                >List Outlet Program Ethical</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-md px-3">
      <h4 class="mb-3 mt-4 text-primary">SKP Program Ethical</h4>

      <!-- Form pencarian dan filter -->
      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-3">
          <input
            type="text"
            id="nipInput"
            class="form-control"
            placeholder="Cari NIP atau Kode PI..."
          />
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" id="searchBtn">Search</button>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filterProgram">
            <option value="">Semua Program</option>
            <option>Boost Metabolic</option>
            <option value="Presentasi Produk Neuro Pain Metabolic">
              Presentasi Produk Neuro Pain Metabolic
            </option>
            <option>Insentif Mod & Rozgra</option>
            <option>POP</option>
            <option>PGD</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filterStatus">
            <option value="">Semua Status</option>
            <option>Approved</option>
            <option>Rejected</option>
            <option>Sudah Upload SKP</option>
            <option>Sudah Generate SKP</option>
            <option>Belum Generate SKP</option>
          </select>
        </div>
        <div class="col-md-3">
          <input
            type="text"
            id="filterOutlet"
            class="form-control"
            placeholder="Filter Nama Outlet..."
          />
        </div>
      </div>

      <!-- Garis -->
      <hr />

      <!-- List hasil -->
      <div class="row" id="skpList"></div>

      <!-- üîπ Modal Upload SKP -->
      <div
        class="modal fade"
        id="uploadSkpModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Upload File SKP</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <p class="mb-2">Outlet: <b id="modalOutletName">-</b></p>
              <input
                type="file"
                class="form-control mb-3"
                id="modalUploadFile"
                accept=".pdf,image/png,image/jpeg"
              />
              <small class="text-secondary"
                >Format: PDF, JPG, PNG & Ukuran Maks: 5 MB</small
              >
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button
                type="button"
                class="btn btn-success"
                id="btnConfirmUpload"
              >
                Upload
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let allSKPData = [];

      $(document).ready(function () {
        $("#searchBtn").on("click", function () {
          const nip = $("#nipInput").val().trim();

          if (!nip) {
            Swal.fire({
              icon: "warning",
              title: "Perhatian!",
              text: "Silakan isi NIP terlebih dahulu.",
            });
            return;
          }

          // üîπ Reset semua filter ketika search
          $("#filterProgram").val("");
          $("#filterStatus").val("");
          $("#filterOutlet").val("");

          $("#skpList").empty();

          getDataByNIP(nip);
        });

        // Filter event
        $("#filterProgram, #filterStatus, #filterOutlet, #nipInput").on(
          "input change",
          applyFilters
        );
      });

      function getDataByNIP(nip) {
        const apiURL =
          "https://script.google.com/macros/s/AKfycby8yvOjfrRMHBQVT-X6JmdJcfS2lkzyCwLvxVpkci_WIcYiCZDtp59_IM08tyGufog-bQ/exec";

        Swal.fire({
          title: "Memuat data...",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        fetch(`${apiURL}?nip=${encodeURIComponent(nip)}`)
          .then((res) => res.json())
          .then((data) => {
            Swal.close();

            const allEmpty = Object.values(data).every(
              (arr) => arr.length === 0
            );
            if (allEmpty) {
              Swal.fire({
                icon: "info",
                title: "Tidak ada data",
                text: "Tidak ada data yang ditemukan untuk NIP tersebut.",
              });
              return;
            }

            console.log(JSON.stringify(data, null, 2));

            // Gabungkan semua array program
            allSKPData = [
              ...(data["Boost Metabolic"] || []).map((item) => ({
                ...item,
                program: "Boost Metabolic",
              })),
              ...(data["POP"] || []).map((item) => ({
                ...item,
                program: "POP",
              })),
              ...(data["PGD"] || []).map((item) => ({
                ...item,
                program: "PGD",
              })),
              ...(data["Insentif Mod & Rozgra"] || []).map((item) => ({
                ...item,
                program: "Insentif Mod & Rozgra",
              })),
              ...(data["Presentasi Produk Neuro Pain Metabolic"] || []).map(
                (item) => ({
                  ...item,
                  program: "Presentasi Produk Neuro Pain Metabolic",
                })
              ),
            ];

            renderSKPCards(allSKPData);
          })
          .catch((err) => {
            Swal.close();
            console.error(err);
            Swal.fire({
              icon: "error",
              title: "Terjadi kesalahan",
              text: "Gagal mengambil data dari server.",
            });
          });
      }

      function applyFilters() {
        const programFilter = $("#filterProgram").val();
        const statusFilter = $("#filterStatus").val().toLowerCase();
        const outletFilter = $("#filterOutlet").val().toLowerCase();
        const kodePiSearch = $("#nipInput").val().toLowerCase();

        const filtered = allSKPData.filter((item) => {
          const programMatch = !programFilter || item.program === programFilter;
          const statusMatch =
            !statusFilter ||
            (item.statusSKP || "").toLowerCase().includes(statusFilter);
          const outletMatch =
            !outletFilter ||
            (item.namaOutlet || "").toLowerCase().includes(outletFilter);
          const kodePiMatch =
            !kodePiSearch ||
            (item.kodePI || "").toLowerCase().includes(kodePiSearch) ||
            (item.nip || "").toLowerCase().includes(kodePiSearch);

          return programMatch && statusMatch && outletMatch && kodePiMatch;
        });

        renderSKPCards(filtered);
      }

      function renderSKPCards(dataArray) {
        const skpList = $("#skpList");
        skpList.empty();

        if (!dataArray.length) {
          skpList.append(
            `<div class="col-12 text-center text-muted mt-3">Tidak ada data sesuai filter</div>`
          );
          return;
        }

        dataArray.forEach((item) => {
          // üîπ Link jika ada
          const downloadLink = item.generateSkp
            ? `<a href="${item.generateSkp}" target="_blank" class="d-block text-primary text-decoration-underline small mb-1">
         Download SKP
       </a>`
            : "";

          const uploadedLink = item.uploadSkp
            ? `<a href="${item.uploadSkp}" target="_blank" class="d-block text-success text-decoration-underline small mb-1">
         Uploaded SKP
       </a>`
            : "";

          // üîπ Card Template
          const card = `
      <div class="col-md-6 mb-4">
        <div class="card card-modern h-100 shadow-sm border-0">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <p class="fw-semibold text-dark m-0">${item.id || "-"}</p>
            <small class="text-muted">${formatDate(item.timeStamp)}</small>
          </div>

          <div class="card-body py-3">
            <div class="mb-2">
              <small class="text-secondary">Nama Outlet</small>
              <p class="fw-bold fs-5 text-primary mb-1">${
                item.namaOutlet || "-"
              }</p>
              <p class="text-muted m-0"><strong>${
                item.kodePI || "-"
              }</strong> | ${item.kota || "-"}</p>
            </div>

            <div class="row">
              <div class="col-6">
                <small class="text-secondary">Status</small>
                <p class="fw-bold m-0">${item.statusSKP || "-"}</p>
              </div>
              <div class="col-6 ps-0">
                <small class="text-secondary">Tipe Program</small>
                <p class="fw-bold m-0">${item.program || "-"}</p>
              </div>
            </div>

            <div class="row mt-2">
              <div class="col-6">
                <small class="text-secondary">Diajukan oleh</small>
                <p class="fw-bold m-0">${item.namaPengaju || "-"}</p>
              </div>
              <div class="col-6 ps-0">
                <small class="text-secondary">NIP</small>
                <p class="fw-bold m-0">${item.nip || "-"}</p>
              </div>
            </div>
          </div>

          <div class="card-footer bg-white border-0 pt-0">
            <div class="d-flex justify-content-between mt-2 gap-2">
              <div class="w-50 d-flex flex-column justify-content-end" style="min-height:65px;">
                ${downloadLink}
                ${(() => {
                  const disabled = item.generateSkp ? "disabled" : "";
                  const btnClass = item.generateSkp
                    ? "btn-secondary"
                    : "text-white";
                  const btnStyle = item.generateSkp
                    ? ""
                    : "background-color: var(--bs-primary);";
                  return `
                    <button 
                      type="button" 
                      class="btn w-100 ${btnClass} mt-1"
                      style="${btnStyle}" 
                      ${disabled}
                      onclick="generateSkp('${item.program}','${item.id}')">
                      Generate SKP
                    </button>
                  `;
                })()}
              </div>
              <div class="w-50 d-flex flex-column justify-content-end" style="min-height:65px;">
                ${uploadedLink}
                <input type="file" id="uploadInput-${
                  item.id
                }" hidden accept=".pdf,image/png,image/jpeg" />
                <button 
                  type="button" 
                  class="btn w-100 text-white mt-1"
                  style="background-color: #009045;" 
                  onclick="openUploadModal('${item.program}','${
            item.namaOutlet
          }','${item.id}')">
                  Upload SKP
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
          skpList.append(card);

          // üîπ Event listener untuk file input
          $(`#uploadInput-${item.id}`).on("change", function (event) {
            const file = event.target.files[0];
            if (file) {
              uploadSkp(item.program, item.namaOutlet, item.id, file);
            }
          });
        });
      }

      function formatDate(isoString) {
        if (!isoString) return "-";
        const date = new Date(isoString);
        return date.toLocaleString("id-ID", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    </script>

    <script>
      const apiURL =
        "https://script.google.com/macros/s/AKfycbz826AQlFzxMepG_MrJc-Cq4X2CCbX0tDgNoAyW-gDeAkzJK3FcVAUi8TJs3-mFN3N5/exec";

      function generateSkp(program, id) {
        console.log(program);
        Swal.fire({
          title: "Membuat SKP...",
          text: "Tunggu sebentar, data sedang diproses :)",
          allowOutsideClick: false,
          allowEscapeKey: false,
          allowEnterKey: false,
          didOpen: () => Swal.showLoading(),
        });

        const url = `${apiURL}?action=generateSkp&program=${encodeURIComponent(
          program
        )}&id=${encodeURIComponent(id)}`;

        fetch(url)
          .then((res) => res.json())
          .then((result) => {
            Swal.close();
            if (result.success) {
              const outletName =
                allSKPData.find((d) => d.id === id && d.program === program)
                  ?.namaOutlet || "Outlet";

              Swal.fire({
                icon: "success",
                title: "Generate SKP Berhasil",
                html: `SKP untuk <b>${outletName}</b> berhasil dibuat!<br>
                  <a href="${result.url}" target="_blank" 
                    class="d-inline-block mt-2 text-primary text-decoration-underline">
                    Download SKP
                  </a>`,
              });

              // üîπ Update data di allSKPData
              const idx = allSKPData.findIndex(
                (d) => d.id === id && d.program === program
              );
              if (idx !== -1) {
                allSKPData[idx].generateSkp = result.url;
              }

              // üîπ Update DOM link download SKP di card
              const card = $(`button[onclick*="'${id}'"]`).closest(".card");
              const footer = card.find(".card-footer .w-50:first");
              const existingLink = footer.find("a.text-primary");

              if (existingLink.length === 0) {
                footer.prepend(
                  `<a href="${result.url}" target="_blank" class="d-block text-primary text-decoration-underline small mb-1">Download SKP</a>`
                );
              } else {
                existingLink.attr("href", result.url);
              }
              const generateBtn = card.find('button[onclick*="generateSkp"]');
              generateBtn.prop("disabled", true);
              generateBtn.removeClass("text-white").addClass("btn-secondary");
              generateBtn.css("background-color", "");
            } else {
              Swal.fire({
                icon: "error",
                title: "Gagal",
                text: result.message,
              });
            }
          })
          .catch(() => {
            Swal.close();
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Gagal generate SKP.",
            });
          });
      }
      function uploadSkp(program, outletName, id, file) {
        const allowedTypes = ["application/pdf", "image/jpeg", "image/png"];
        const MAX_SIZE_MB = 5; // üîπ Maksimal 10 MB

        if (!allowedTypes.includes(file.type)) {
          Swal.fire({
            icon: "warning",
            title: "Format file tidak didukung!",
            text: "Hanya PDF, JPG, JPEG, atau PNG yang diperbolehkan.",
          });
          return;
        }

        // üîπ Cek ukuran file
        if (file.size > MAX_SIZE_MB * 1024 * 1024) {
          Swal.fire({
            icon: "warning",
            title: "File Terlalu Besar!",
            html: `Ukuran file maksimal <b>${MAX_SIZE_MB} MB</b>.<br>
             File yang dipilih berukuran <b>${(file.size / 1024 / 1024).toFixed(
               2
             )} MB</b>.`,
          });
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const base64File = e.target.result.split(",")[1];

          Swal.fire({
            title: "Mengupload SKP...",
            text: "Tunggu sebentar, data sedang diproses :)",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          fetch(apiURL, {
            method: "POST",
            body: new URLSearchParams({
              action: "uploadSkp",
              program: program,
              id: id,
              file: base64File,
              filename: file.name,
              mimeType: file.type,
            }),
          })
            .then((res) => res.json())
            .then((result) => {
              Swal.close();
              if (result.success) {
                const outletName =
                  allSKPData.find((d) => d.id === id && d.program === program)
                    ?.namaOutlet || "Outlet";

                Swal.fire({
                  icon: "success",
                  title: "Upload SKP Berhasil",
                  html: `File SKP untuk <b>${outletName}</b> berhasil diupload!<br>
            <a href="${result.url}" target="_blank" 
              class="d-inline-block mt-2 text-success text-decoration-underline">
              Uploaded SKP
            </a>`,
                });

                // üîπ Update data di allSKPData
                const idx = allSKPData.findIndex(
                  (d) => d.id === id && d.program === program
                );
                if (idx !== -1) {
                  allSKPData[idx].uploadSkp = result.url;
                }

                // üîπ Update link uploaded di DOM
                const card = $(`button[onclick*="'${id}'"]`).closest(".card");
                const footer = card.find(".card-footer .w-50:last");
                const existingLink = footer.find("a.text-success");

                if (existingLink.length === 0) {
                  footer.prepend(
                    `<a href="${result.url}" target="_blank" class="d-block text-success text-decoration-underline small mb-1">Uploaded SKP</a>`
                  );
                } else {
                  existingLink.attr("href", result.url);
                }
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Gagal Upload",
                  text: result.message,
                });
              }
            })
            .catch(() => {
              Swal.close();
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Gagal upload file.",
              });
            });
        };

        reader.readAsDataURL(file);
      }

      let currentUpload = { program: "", outlet: "", id: "" };

      function openUploadModal(program, outletName, id) {
        // üîπ Cari data SKP berdasarkan program & id
        const data = allSKPData.find(
          (d) => d.id === id && d.program === program
        );

        // üîπ Cek apakah SKP sudah di-generate
        if (!data || !data.generateSkp) {
          Swal.fire({
            icon: "warning",
            title: "Belum Generate SKP",
            text: "Silakan generate SKP terlebih dahulu sebelum upload.",
          });
          return; // ‚ùå Stop, tidak buka modal
        }

        // üîπ Jika file sudah pernah diupload, beri konfirmasi
        if (data.uploadSkp) {
          Swal.fire({
            icon: "warning",
            title: "File SKP Sudah Ada",
            html: `File SKP untuk <b>${outletName}</b> sudah diupload sebelumnya.<br><br>
             Apakah Anda ingin mengganti file lama dengan file baru?`,
            showCancelButton: true,
            confirmButtonText: "Ya, Ganti File",
            cancelButtonText: "Batal",
            reverseButtons: true,
          }).then((result) => {
            if (result.isConfirmed) {
              // üîπ Tampilkan modal upload jika user setuju
              currentUpload = { program, outlet: outletName, id };
              $("#modalOutletName").text(outletName);
              $("#modalUploadFile").val(""); // reset file input
              $("#uploadSkpModal").modal("show");
            }
          });
        } else {
          // üîπ Jika belum pernah upload, langsung buka modal
          currentUpload = { program, outlet: outletName, id };
          $("#modalOutletName").text(outletName);
          $("#modalUploadFile").val(""); // reset file input
          $("#uploadSkpModal").modal("show");
        }
      }

      $("#btnConfirmUpload").on("click", function () {
        const file = $("#modalUploadFile")[0].files[0];
        if (!file) {
          Swal.fire({ icon: "warning", title: "Pilih file terlebih dahulu!" });
          return;
        }

        // üîπ Jalankan upload
        $("#uploadSkpModal").modal("hide");
        uploadSkp(
          currentUpload.program,
          currentUpload.outlet,
          currentUpload.id,
          file
        );
      });
      window.addEventListener("load", () => {
        const loader = document.getElementById("loader-wrapper");
        if (loader) {
          loader.classList.add("fade-out");
          setTimeout(() => loader.remove(), 500); // Hapus loader setelah animasi selesai
        }
      });
    </script>
  </body>
</html>
