<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Program Ethical</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCwxPY-M6lwt7JLZEeexUrhKVgVZj_enHE",
        authDomain: "data-outlet-pharos.firebaseapp.com",
        projectId: "data-outlet-pharos",
        storageBucket: "data-outlet-pharos.appspot.com",
        messagingSenderId: "651086534605",
        appId: "1:651086534605:web:228339d21beb359a709684",
        measurementId: "G-7FQQZ2K3T0",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://connect-assets.prosple.com/cdn/ff/nDJLhKo3GxHUnuJJLt-cRdMGUAmxDY2NSAzboL84_ec/1700559379/public/styles/scale_and_crop_center_120x120/public/2023-11/Logo-Pharos-Indonesia-200x200-2023.jpg?itok=4-AmM7sn"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background: #ffffff;
        font-family: "Roboto", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      .navbar-custom {
        background-color: #0d6efd;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .navbar-brand {
        display: flex;
        align-items: center;
        font-size: 1.4rem;
        font-weight: bold;
      }

      /* Hover Effect Navbar */
      .navbar-nav .nav-link {
        transition: background-color 0.3s, color 0.3s;
        border-radius: 0.3rem;
      }

      .navbar-nav .nav-link:hover {
        background-color: #0b5ed7;
        color: #fff;
      }
      .card {
        border-radius: 1rem;
        box-shadow: 0 0 30px rgba(13, 110, 253, 0.15);
        background-color: #ffffff;
        padding: 1.5rem 1.75rem;
      }
      .select2-container--bootstrap4 {
        width: 100% !important;
      }
      h2 {
        font-weight: bold;
        margin-bottom: 1rem;
        color: #0d6efd;
      }
      .form-control,
      .form-select {
        border-radius: 0.5rem;
        padding: 0.55rem 0.9rem;
      }
      .btn-primary {
        background-color: #0d6efd;
        border: none;
        padding: 0.65rem;
        font-weight: 500;
        border-radius: 0.5rem;
      }
      .btn-primary:hover {
        background-color: #0b5ed7;
      }
      .form-check-input {
        width: 1.2em;
        height: 1.2em;
        margin-top: 0.1em;
        margin-right: 10px;
        vertical-align: middle;
      }
      ::placeholder {
        color: #bbb !important;
        opacity: 1;
      }
      #loader-wrapper.fade-out {
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }
      /* Gaya untuk checkbox agar outline hitam */
      .form-check-input[type="checkbox"] {
        border-color: #000; /* Outline hitam */
      }

      /* Saat dicentang */
      .form-check-input[type="checkbox"]:checked {
        background-color: #0b5ed7; /* Kotak hitam */
        border-color: #000; /* Outline hitam */
      }

      /* Hover agar terlihat interaktif */
      .form-check-input[type="checkbox"]:hover {
        border-color: #0b5ed7;
      }

      /* Fokus agar tetap outline hitam */
      .form-check-input[type="checkbox"]:focus {
        border-color: #000;
        box-shadow: 0 0 0 0.25rem rgba(0, 0, 0, 0.25);
      }
      /* Logo LUMORA */
      .lumora-logo {
        font-family: "Orbitron", sans-serif;
        letter-spacing: 1px;
        font-size: 1.6rem;
        display: inline-block;
        color: #ffd54f;
        animation: goldGlow 3s ease-in-out infinite,
          floatY 4s ease-in-out infinite;
        text-shadow: 0 0 4px #fff8e1, 0 0 8px #ffcc80;
      }

      /* Icon Petir */
      .lightning-icon {
        animation: yellowFlash 2.2s ease-in-out infinite,
          floatY 4s ease-in-out infinite;
        transform-origin: center;
        filter: drop-shadow(0 0 4px #fff8e1) drop-shadow(0 0 8px #ffcc80);
      }

      /* Animasi Glow Teks */
      @keyframes goldGlow {
        0%,
        100% {
          text-shadow: 0 0 4px #fff8e1, 0 0 8px #ffcc80;
          color: #ffd54f;
        }
        50% {
          text-shadow: 0 0 6px #fff4c2, 0 0 12px #ffb74d;
          color: #ffb300;
        }
      }

      /* Animasi Floating */
      @keyframes floatY {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-2px);
        }
      }

      /* Animasi Flash Petir */
      @keyframes yellowFlash {
        0%,
        100% {
          fill: #ffffff;
          filter: drop-shadow(0 0 3px #fff9c4) drop-shadow(0 0 6px #ffecb3);
        }
        50% {
          fill: #ffeb3b;
          filter: drop-shadow(0 0 5px #fff4c2) drop-shadow(0 0 10px #ffd54f);
        }
      }
    </style>
  </head>
  <!-- Loader -->
  <div
    id="loader-wrapper"
    style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    "
  >
    <div
      class="spinner-border text-primary"
      role="status"
      style="width: 4rem; height: 4rem"
    >
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top"
    >
      <div class="container">
        <!-- Brand -->
        <a
          class="navbar-brand d-flex align-items-center gap-2 ms-2 me-3"
          href="#"
        >
          <!-- Icon Petir -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            class="bi bi-lightning-charge-fill lightning-icon"
            viewBox="0 0 16 16"
          >
            <path d="M11 0L6 9h4l-1 7 5-10H9l2-6z" />
          </svg>

          <!-- Nama Brand -->
          <span class="text-white lumora-logo animated-logo">LUMORA</span>
        </a>

        <!-- Hamburger Toggle -->
        <button
          class="navbar-toggler ms-auto"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
          aria-controls="navbarContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu Navbar -->
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav mt-2 mt-lg-0 ms-2">
            <li class="nav-item">
              <a
                class="nav-link text-white fw-bold ms-1"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/form-pendaftaran-program-ethical"
                >Form Ethical</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link text-white fw-bold ms-1"
                href="https://abednegochristianyoel.github.io/Form-Sales-Force-Effectiveness/skp-program-ethical/"
                >SKP Program Ethical</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container my-4">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <h2 class="text-center mb-3 mt-2">
              Form Pengajuan Program Ethical
            </h2>
            <h5 class="fw-bold text-primary mt-1 mb-0 pb-0">Input Data Diri</h5>
            <hr
              class="mx-auto mt-3 mb-3"
              style="border-top: 3px dashed #5f5f5f; width: 100%"
            />
            <form id="ethicalForm">
              <div class="row g-3 align-items-end">
                <div class="col-md-8">
                  <label for="nipEthical" class="form-label">NIP</label>
                  <input
                    type="text"
                    id="nipEthical"
                    class="form-control"
                    placeholder="Masukkan NIP"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <button
                    type="button"
                    class="btn btn-primary w-100"
                    id="searchEthicalBtn"
                  >
                    Check NIP
                  </button>
                </div>

                <div class="col-12">
                  <label class="form-label">Nama</label>
                  <input
                    type="text"
                    id="namaEthical"
                    class="form-control"
                    disabled
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Jabatan</label>
                  <input
                    type="text"
                    id="jabatanEthical"
                    class="form-control"
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Divisi</label>
                  <input
                    type="text"
                    id="divisiEthical"
                    class="form-control"
                    disabled
                  />
                </div>
                <div class="col-12 mb-2 mt-4">
                  <h5 class="fw-bold text-primary mt-1 mb-3">
                    Input Detail Program
                  </h5>
                  <hr class="my-2" style="border-top: 3px dashed #5f5f5f" />
                </div>

                <div class="col-md-6 mt-0 mb-3 mb-md-0">
                  <label for="outletEthical" class="form-label"
                    >Kode Outlet</label
                  >
                  <select id="outletEthical" class="form-select" required>
                    <option value="">Pilih Outlet</option>
                  </select>
                </div>
                <div class="col-md-6 mt-0">
                  <label for="programEthical" class="form-label"
                    >Pilih Program</label
                  >
                  <select id="programEthical" class="form-select" required>
                    <option value="">Pilih Program</option>
                    <option value="Boost Metabolic">Boost Metabolic</option>
                    <option value="Insentif SC Modafil & Rozgra">
                      Insentif SC Modafil & Rozgra
                    </option>
                    <option value="POP">POP</option>
                    <option value="PGD">PGD</option>
                    <option value="PK to PBF">PK to PBF</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Kode PI</label>
                  <input
                    type="text"
                    id="kodePiEthical"
                    class="form-control"
                    disabled
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Nama Outlet</label>
                  <input
                    type="text"
                    id="namaOutletEthical"
                    class="form-control"
                    disabled
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Kota</label>
                  <input
                    type="text"
                    id="kotaOutletEthical"
                    class="form-control"
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Alamat Outlet</label>
                  <input
                    type="text"
                    id="alamatOutletEthical"
                    class="form-control"
                    disabled
                  />
                </div>

                <div id="produkDipilihWrapper" class="col-12 d-none mt-3">
                  <label class="form-label">Produk yang Dipilih</label>
                  <select id="produkDipilih" class="form-select">
                    <option value="">Pilih Produk</option>
                    <option value="Rozgra Group">Rozgra Group</option>
                    <option value="Modafil">Modafil</option>
                    <option value="Modafil & Rozgra">Modafil & Rozgra</option>
                  </select>
                </div>

                <!-- Tambahan untuk Program Insentif SC Modafil & Rozgra -->
                <div id="jenisHadiahWrapper" class="col-12 d-none">
                  <label class="form-label">Jenis Hadiah</label>
                  <select id="jenisHadiah" class="form-select">
                    <option value="">Pilih Jenis Hadiah</option>
                    <option value="E-Wallet">E-Wallet</option>
                    <option value="Transfer Bank">Transfer Bank</option>
                  </select>
                </div>

                <!-- Detail E-Wallet -->
                <div id="ewalletFields" class="row d-none">
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Jenis E-Wallet</label>
                    <select id="jenisEwallet" class="form-select">
                      <option value="">Pilih E-Wallet</option>
                      <option value="Dana">Dana</option>
                      <option value="Gopay">Gopay</option>
                      <option value="Ovo">Ovo</option>
                      <option value="ShopeePay">ShopeePay</option>
                    </select>
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label">No. Telp Akun</label>
                    <input
                      type="tel"
                      id="noTelpEwallet"
                      class="form-control"
                      pattern="[0-9]{10,15}"
                      oninvalid="this.setCustomValidity('Nomor telepon harus 10–15 digit angka')"
                      oninput="this.setCustomValidity('')"
                    />
                  </div>
                  <div class="col-12 mt-3">
                    <label class="form-label">Nama Akun E-Wallet</label>
                    <input
                      type="text"
                      id="namaAkunEwallet"
                      class="form-control"
                    />
                  </div>
                </div>

                <!-- Detail Transfer Bank -->
                <div id="bankFields" class="row d-none">
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Nama Bank</label>
                    <input type="text" id="namaBank" class="form-control" />
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label">No. Rekening</label>
                    <input type="text" id="noRek" class="form-control" />
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Nama Akun Bank</label>
                    <input type="text" id="namaAkunBank" class="form-control" />
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Cabang Bank</label>
                    <input type="text" id="cabangBank" class="form-control" />
                  </div>
                </div>

                <!-- Tambahan untuk Program POP dan PGD -->
                <div id="popPgdFields" class="row d-none">
                  <div class="col-md-6 mt-3">
                    <label class="form-label">Estimasi Tanggal Realisasi</label>
                    <input
                      type="date"
                      id="tanggalRealisasi"
                      class="form-control"
                    />
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label"
                      >Jumlah Peserta (Pack), Include PSR</label
                    >
                    <input
                      type="number"
                      id="jumlahPeserta"
                      class="form-control"
                      min="1"
                    />
                  </div>
                </div>

                <div id="boostMetabolicFields" class="row g-3 d-none mt-0">
                  <div id="produkSwitchWrapper" class="row g-3 d-none">
                    <div class="col-12 mt-1">
                      <label class="form-label fw-bold">Pilihan Produk</label>
                    </div>

                    <div class="col-md-3">
                      <div class="form-check">
                        <input
                          class="form-check-input produkSwitch"
                          type="checkbox"
                          id="Profibrat200"
                          data-label="Profibrat 200 mg"
                        />
                        <label class="form-check-label" for="Profibrat200">
                          Profibrat 200 mg
                        </label>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="form-check">
                        <input
                          class="form-check-input produkSwitch"
                          type="checkbox"
                          id="Stavinor10"
                          data-label="Stavinor 10 mg"
                        />
                        <label class="form-check-label" for="Stavinor10">
                          Stavinor 10 mg
                        </label>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="form-check">
                        <input
                          class="form-check-input produkSwitch"
                          type="checkbox"
                          id="Stavinor20"
                          data-label="Stavinor 20 mg"
                        />
                        <label class="form-check-label" for="Stavinor20">
                          Stavinor 20 mg
                        </label>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="form-check">
                        <input
                          class="form-check-input produkSwitch"
                          type="checkbox"
                          id="Stavinor40"
                          data-label="Stavinor 40 mg"
                        />
                        <label class="form-check-label" for="Stavinor40">
                          Stavinor 40 mg
                        </label>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="form-check">
                        <input
                          class="form-check-input produkSwitch"
                          type="checkbox"
                          id="Vastrol10"
                          data-label="Vastrol 10 mg"
                        />
                        <label class="form-check-label" for="Vastrol10">
                          Vastrol 10 mg
                        </label>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="form-check">
                        <input
                          class="form-check-input produkSwitch"
                          type="checkbox"
                          id="Vastrol20"
                          data-label="Vastrol 20 mg"
                        />
                        <label class="form-check-label" for="Vastrol20">
                          Vastrol 20 mg
                        </label>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="form-check">
                        <input
                          class="form-check-input produkSwitch"
                          type="checkbox"
                          id="Rechol10"
                          data-label="Rechol 10 mg"
                        />
                        <label class="form-check-label" for="Rechol10">
                          Rechol 10 mg
                        </label>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <div class="form-check">
                        <input
                          class="form-check-input produkSwitch"
                          type="checkbox"
                          id="Rechol20"
                          data-label="Rechol 20 mg"
                        />
                        <label class="form-check-label" for="Rechol20">
                          Rechol 20 mg
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-12">
                    <label for="namaApoteker" class="form-label"
                      >Nama Apoteker / Owner</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="namaApoteker"
                      name="namaApoteker"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="telpApoteker" class="form-label"
                      >No. Telp / WA</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="telpApoteker"
                      name="telpApoteker"
                      pattern="08[0-9]{8,13}"
                      maxlength="15"
                      oninvalid="this.setCustomValidity('Nomor harus diawali 08 dan terdiri dari 10–15 digit angka')"
                      oninput="this.setCustomValidity('')"
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="emailApoteker" class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      id="emailApoteker"
                      name="emailApoteker"
                      oninvalid="this.setCustomValidity('Silakan masukkan email yang valid')"
                      oninput="this.setCustomValidity('')"
                    />
                  </div>
                </div>

                <div id="tanggalPelaksanaanPK" class="mb-12 d-none">
                  <label for="tanggalPK" class="form-label"
                    >Tanggal Pelaksanaan</label
                  >
                  <input type="date" class="form-control" id="tanggalPK" />
                </div>

                <div class="col-12 mt-1 mt-4">
                  <div class="p-2 border border-dark border-2 rounded">
                    <div class="form-check d-flex align-items-center">
                      <input
                        class="form-check-input me-2 mt-0"
                        type="checkbox"
                        id="confirmCheck"
                        required
                      />
                      <label
                        class="form-check-label fw-medium mb-0"
                        for="confirmCheck"
                      >
                        <strong
                          >SAYA MENYATAKAN DATA YANG DIISI SUDAH BENAR</strong
                        >
                      </label>
                    </div>
                  </div>
                </div>

                <div class="col-12 mt-4">
                  <button type="submit" class="btn btn-primary w-100">
                    Submit Data
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbyCfQvH4DUpdzSfHbdcZLrH1xWQSK2fAUgXef2s5KjS65ywawThz7JnJ1u8b_6H_slnog/exec";
      let globalOutletData = {};

      // Fungsi untuk mengatur required secara dinamis
      function setFieldRequired(selector, required = true) {
        const field = document.querySelector(selector);
        if (field) {
          if (required) {
            field.setAttribute("required", "required");
          } else {
            field.removeAttribute("required");
          }
        }
      }
      // Fungsi untuk reset semua field setelah biodata
      function resetFormSetelahBiodata() {
        const fieldsToClear = [
          "#outletEthical",
          "#programEthical",
          "#kodePiEthical",
          "#namaOutletEthical",
          "#kotaOutletEthical",
          "#alamatOutletEthical",
          "#produkDipilih",
          "#jenisHadiah",
          "#jenisEwallet",
          "#noTelpEwallet",
          "#namaAkunEwallet",
          "#namaBank",
          "#noRek",
          "#namaAkunBank",
          "#cabangBank",
          "#tanggalRealisasi",
          "#jumlahPeserta",
          "#Profibrat200",
          "#Stavinor10",
          "#Stavinor20",
          "#Stavinor40",
          "#Vastrol10",
          "#Vastrol20",
          "#Rechol10",
          "#Rechol20",
        ];

        fieldsToClear.forEach((id) => {
          const el = document.querySelector(id);
          if (el) el.value = "";
        });

        $("#outletEthical").val(null).trigger("change");
        $("#programEthical").val(null).trigger("change");
        $("#confirmCheck").prop("checked", false);

        $("#produkDipilihWrapper").addClass("d-none");
        $("#jenisHadiahWrapper").addClass("d-none");
        $("#ewalletFields").addClass("d-none");
        $("#bankFields").addClass("d-none");
        $("#popPgdFields").addClass("d-none");
        $("#boostMetabolicFields").addClass("d-none");
        $("#produkSwitchWrapper").addClass("d-none");
        $("#tanggalPelaksanaanPK").addClass("d-none");

        [
          "#produkDipilih",
          "#jenisHadiah",
          "#jenisEwallet",
          "#noTelpEwallet",
          "#namaAkunEwallet",
          "#namaBank",
          "#noRek",
          "#namaAkunBank",
          "#cabangBank",
          "#tanggalRealisasi",
          "#jumlahPeserta",
        ].forEach((id) => setFieldRequired(id, false));
      }

      $("#outletEthical").select2({
        theme: "bootstrap4",
        placeholder: "Pilih Outlet",
        allowClear: true,
      });
      $("#programEthical").select2({
        theme: "bootstrap4",
        placeholder: "Pilih Program",
        allowClear: true,
      });

      document
        .getElementById("searchEthicalBtn")
        .addEventListener("click", () => {
          const nip = document.getElementById("nipEthical").value.trim();
          if (!nip)
            return Swal.fire(
              "Perhatian",
              "Harap isi NIP terlebih dahulu.",
              "warning"
            );

          Swal.fire({
            title: "Mencari data...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          fetch(
            `https://data-outlet-pharos-default-rtdb.firebaseio.com/${nip}.json`
          )
            .then((res) => res.json())
            .then((data) => {
              Swal.close();

              if (!data || !data.nama)
                return Swal.fire(
                  "Tidak Ditemukan",
                  "Data NIP tidak ditemukan.",
                  "error"
                );

              document.getElementById("namaEthical").value = data.nama || "";
              document.getElementById("jabatanEthical").value =
                data.jabatan || "";
              document.getElementById("divisiEthical").value =
                data.divisi || "";

              resetFormSetelahBiodata();

              const jabatan = (data.jabatan || "").toUpperCase();
              const divisi = (data.divisi || "").toUpperCase();
              const programSelect = document.getElementById("programEthical");

              // Reset program
              programSelect.innerHTML = `
            <option value="">Pilih Program</option>
            <option value="Boost Metabolic">Boost Metabolic</option>
            <option value="Insentif SC Modafil & Rozgra">Insentif SC Modafil & Rozgra</option>
            <option value="POP">POP</option>
            <option value="PGD">PGD</option>
          `;

              if (
                jabatan === "NSM" &&
                (divisi === "VBR" || divisi === "MSA1")
              ) {
                const optionPK = document.createElement("option");
                optionPK.value = "PK to PBF";
                optionPK.textContent = "PK to PBF";
                programSelect.appendChild(optionPK);
              }

              $("#programEthical").val(null).trigger("change");

              const select = document.getElementById("outletEthical");
              select.innerHTML = `<option value="">Pilih Outlet</option>`;
              globalOutletData = {};

              (data.outlets || []).forEach((outlet) => {
                const kode = outlet.kode;
                globalOutletData[kode] = outlet;
                const opt = document.createElement("option");
                opt.value = kode;
                opt.textContent = `${kode}`;
                select.appendChild(opt);
              });

              $("#outletEthical").select2("destroy");
              $("#outletEthical").select2({
                theme: "bootstrap4",
                placeholder: "Pilih Outlet",
                allowClear: true,
              });
            })
            .catch((err) => {
              console.error("Fetch error:", err);
              Swal.close();
              Swal.fire({
                icon: "error",
                title: "Gagal Mengambil Data",
                html: `Terjadi kesalahan saat mengambil data dari server.<br><small>${
                  err.message || err
                }</small>`,
              });
            });
        });

      document
        .getElementById("ethicalForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const nip = document.getElementById("nipEthical").value.trim();
          const outlet = document.getElementById("outletEthical").value;
          const program = document.getElementById("programEthical").value;
          const kodePi = document.getElementById("kodePiEthical").value;
          const namaOutlet = document.getElementById("namaOutletEthical").value;
          const kota = document.getElementById("kotaOutletEthical").value;
          const alamat = document.getElementById("alamatOutletEthical").value;

          if (!nip || !outlet || !program) {
            return Swal.fire(
              "Lengkapi Form",
              "Mohon isi semua field wajib.",
              "warning"
            );
          }

          if (program === "Boost Metabolic") {
            const checkedProduk = document.querySelectorAll(
              '#produkSwitchWrapper input[type="checkbox"]:checked'
            );
            if (checkedProduk.length === 0) {
              return Swal.fire(
                "Pilih Produk",
                "Minimal pilih satu produk untuk Boost Metabolic.",
                "warning"
              );
            }
          }

          const baseData = {
            nip,
            nama: document.getElementById("namaEthical").value,
            jabatan: document.getElementById("jabatanEthical").value,
            divisi: document.getElementById("divisiEthical").value,
            outlet,
            program,
            kodePi,
            namaOutlet,
            kota,
            alamat,
          };

          if (program === "Insentif SC Modafil & Rozgra") {
            baseData.produkDipilih =
              document.getElementById("produkDipilih").value || "";
            baseData.jenisHadiah = document.getElementById("jenisHadiah").value;

            if (baseData.jenisHadiah === "E-Wallet") {
              baseData.jenisEwallet =
                document.getElementById("jenisEwallet").value;
              baseData.noTelpEwallet =
                document.getElementById("noTelpEwallet").value;
              baseData.namaAkunEwallet =
                document.getElementById("namaAkunEwallet").value;
            } else if (baseData.jenisHadiah === "Transfer Bank") {
              baseData.namaBank = document.getElementById("namaBank").value;
              baseData.noRek = document.getElementById("noRek").value;
              baseData.namaAkunBank =
                document.getElementById("namaAkunBank").value;
              baseData.cabangBank =
                document.getElementById("cabangBank").value || "";
            }
          } else if (program === "POP" || program === "PGD") {
            baseData.tanggalRealisasi =
              document.getElementById("tanggalRealisasi").value;
            baseData.jumlahPeserta =
              document.getElementById("jumlahPeserta").value;
          } else if (program === "Boost Metabolic") {
            baseData.namaApoteker =
              document.getElementById("namaApoteker").value || "";
            baseData.telpApoteker =
              document.getElementById("telpApoteker").value || "";
            baseData.emailApoteker =
              document.getElementById("emailApoteker").value || "";

            const switches = document.querySelectorAll(".produkSwitch");

            const produkStatus = Array.from(switches).map((sw) => ({
              label: sw.dataset.label,
              status: sw.checked ? "Yes" : "No",
            }));

            baseData.productMetabolic = JSON.stringify(produkStatus);
          } else if (program === "PK to PBF") {
            baseData.tanggalPelaksanaan =
              document.getElementById("tanggalPK").value || "";
          }

          console.log("Data yang dikirim:", baseData);

          Swal.fire({
            title: "Menyimpan...",
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
          });

          try {
            const res = await fetch(scriptURL, {
              method: "POST",
              body: JSON.stringify(baseData),
              headers: { "Content-Type": "text/plain;charset=utf-8" },
            });

            const result = await res.json(); // <--- penting! Ubah dari res.text() ke res.json()
            Swal.close();

            if (result.status === "Success") {
              Swal.fire("Berhasil", "Data berhasil disimpan.", "success");

              // Reset hanya field setelah biodata
              $("#outletEthical").val(null).trigger("change");
              $("#programEthical").val(null).trigger("change");
              $("#kodePiEthical").val("");
              $("#namaOutletEthical").val("");
              $("#kotaOutletEthical").val("");
              $("#alamatOutletEthical").val("");
              $("#produkDipilih").val("");
              $("#jenisHadiah").val("");
              $("#jenisEwallet").val("");
              $("#noTelpEwallet").val("");
              $("#namaAkunEwallet").val("");
              $("#namaBank").val("");
              $("#noRek").val("");
              $("#namaAkunBank").val("");
              $("#cabangBank").val("");
              $("#tanggalRealisasi").val("");
              $("#jumlahPeserta").val("");
              $("#confirmCheck").prop("checked", false);
              $("#namaApoteker").val("");
              $("#telpApoteker").val("");
              $("#emailApoteker").val("");
              $("#tanggalPK").val("");

              [
                "#Profibrat200",
                "#Stavinor10",
                "#Stavinor20",
                "#Stavinor40",
                "#Vastrol10",
                "#Vastrol20",
                "#Rechol10",
                "#Rechol20",
              ].forEach((id) => {
                const el = document.querySelector(id);
                if (el) el.checked = false;
              });

              // Sembunyikan field dinamis kembali
              $("#produkDipilihWrapper").addClass("d-none");
              $("#jenisHadiahWrapper").addClass("d-none");
              $("#ewalletFields").addClass("d-none");
              $("#bankFields").addClass("d-none");
              $("#popPgdFields").addClass("d-none");
              $("#boostMetabolicFields").addClass("d-none");
              $("#produkSwitchWrapper").addClass("d-none");
              $("#tanggalPelaksanaanPK").addClass("d-none");

              // Hapus required dynamic
              setFieldRequired("#produkDipilih", false);
              setFieldRequired("#jenisHadiah", false);
              setFieldRequired("#jenisEwallet", false);
              setFieldRequired("#noTelpEwallet", false);
              setFieldRequired("#namaAkunEwallet", false);
              setFieldRequired("#namaBank", false);
              setFieldRequired("#noRek", false);
              setFieldRequired("#namaAkunBank", false);
              setFieldRequired("#cabangBank", false);
              setFieldRequired("#tanggalRealisasi", false);
              setFieldRequired("#jumlahPeserta", false);
              setFieldRequired("#namaApoteker", false);
              setFieldRequired("#telpApoteker", false);
              setFieldRequired("#emailApoteker", false);
              setFieldRequired("#tanggalPK", false);
            } else if (result.status === "DUPLIKAT") {
              Swal.fire({
                icon: "error",
                title: "Kode PI sudah diisi",
                html: `
                  Pendaftaran program: <strong>${result.program}</strong><br>
                  Kode PI: <strong>${result.kodePi}</strong><br>
                  Telah diisi oleh: <strong>${result.oleh}</strong><br>
                  Pada: <strong>${result.tanggal}</strong>.
                `,
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Gagal Simpan Data",
                html:
                  result.message || "Terjadi kesalahan yang tidak diketahui.",
              });
            }
          } catch (error) {
            console.error("Submit error:", error);
            Swal.close();
            Swal.fire({
              icon: "error",
              title: "Gagal Submit",
              html: `Terjadi kesalahan pada sistem.<br><small>${
                error.message || error
              }</small>`,
            });
          }
        });

      $("#outletEthical").on("change", function () {
        const kodeOutlet = this.value;
        if (!kodeOutlet || !globalOutletData[kodeOutlet]) return;
        const data = globalOutletData[kodeOutlet];

        $("#kodePiEthical").val(data.kodePi || "");
        $("#namaOutletEthical").val(data.nama || "");
        $("#kotaOutletEthical").val(data.kota || "");
        $("#alamatOutletEthical").val(data.alamat || "");
      });

      $("#programEthical").on("change", function () {
        const selected = $(this).val();

        $("#produkDipilihWrapper").addClass("d-none");
        $("#jenisHadiahWrapper").addClass("d-none");
        $("#ewalletFields").addClass("d-none");
        $("#bankFields").addClass("d-none");
        $("#popPgdFields").addClass("d-none");
        $("#boostMetabolicFields").addClass("d-none");
        $("#produkSwitchWrapper").addClass("d-none");
        $("#tanggalPelaksanaanPK").addClass("d-none");

        setFieldRequired("#produkDipilih", false);
        setFieldRequired("#jenisHadiah", false);
        setFieldRequired("#jenisEwallet", false);
        setFieldRequired("#noTelpEwallet", false);
        setFieldRequired("#namaAkunEwallet", false);
        setFieldRequired("#namaBank", false);
        setFieldRequired("#noRek", false);
        setFieldRequired("#namaAkunBank", false);
        setFieldRequired("#cabangBank", false);
        setFieldRequired("#tanggalRealisasi", false);
        setFieldRequired("#jumlahPeserta", false);
        setFieldRequired("#namaApoteker", false);
        setFieldRequired("#telpApoteker", false);
        setFieldRequired("#emailApoteker", false);

        if (selected === "Insentif SC Modafil & Rozgra") {
          $("#produkDipilihWrapper").removeClass("d-none");
          $("#jenisHadiahWrapper").removeClass("d-none");
          setFieldRequired("#produkDipilih", true);
          setFieldRequired("#jenisHadiah", true);
        } else if (selected === "POP" || selected === "PGD") {
          $("#popPgdFields").removeClass("d-none");
          setFieldRequired("#tanggalRealisasi", true);
          setFieldRequired("#jumlahPeserta", true);
        } else if (selected === "Boost Metabolic") {
          $("#boostMetabolicFields").removeClass("d-none");
          $("#produkSwitchWrapper").removeClass("d-none");
          setFieldRequired("#namaApoteker", true);
          setFieldRequired("#telpApoteker", true);
          setFieldRequired("#emailApoteker", true);
        } else if (selected === "PK to PBF") {
          $("#tanggalPelaksanaanPK").removeClass("d-none");
          setFieldRequired("#tanggalPK", true);
        } else {
          $("#produkDipilihWrapper").addClass("d-none");
          setFieldRequired("#produkDipilih", false);
        }
      });

      $("#jenisHadiah").on("change", function () {
        const jenis = $(this).val();

        $("#ewalletFields").addClass("d-none");
        $("#bankFields").addClass("d-none");

        setFieldRequired("#jenisEwallet", false);
        setFieldRequired("#noTelpEwallet", false);
        setFieldRequired("#namaAkunEwallet", false);
        setFieldRequired("#namaBank", false);
        setFieldRequired("#noRek", false);
        setFieldRequired("#namaAkunBank", false);
        setFieldRequired("#cabangBank", false);

        if (jenis === "E-Wallet") {
          $("#ewalletFields").removeClass("d-none");
          setFieldRequired("#jenisEwallet", true);
          setFieldRequired("#noTelpEwallet", true);
          setFieldRequired("#namaAkunEwallet", true);
        } else if (jenis === "Transfer Bank") {
          $("#bankFields").removeClass("d-none");
          setFieldRequired("#namaBank", true);
          setFieldRequired("#noRek", true);
          setFieldRequired("#namaAkunBank", true);
          setFieldRequired("#cabangBank", true);
        }
      });
      window.addEventListener("load", () => {
        const loader = document.getElementById("loader-wrapper");
        if (loader) {
          loader.classList.add("fade-out");
          setTimeout(() => loader.remove(), 500); // Hapus loader setelah animasi selesai
        }
      });
    </script>
  </body>
</html>
